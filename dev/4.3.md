D∆∞·ªõi ƒë√¢y l√† **T√†i li·ªáu ƒê·∫∑c t·∫£ K·ªπ thu·∫≠t (SRS/PRD) ‚Äì Entry/SL/TP c·ªßa ICT/SMC & Momentum cho EA MT5** ƒë√£ chu·∫©n-ho√° ƒë·ªÉ DEV c√≥ th·ªÉ code **ƒë√∫ng logic** ngay. Em tu√¢n th·ªß c√°c r√†ng bu·ªôc c·ªßa anh:

* **Entry** c√≥ 2 ch·∫ø ƒë·ªô: **SMC pullback** & **Momentum breakout** (c√≥ th·ªÉ b·∫≠t ƒë·ªìng th·ªùi). **∆Øu ti√™n Momentum** khi conflict.
* **TP/SL**: "theo ph∆∞∆°ng ph√°p n√†o th√¨ TP/SL theo ph∆∞∆°ng ph√°p ƒë√≥"; **cho ph√©p override theo pip/points** (nhi·ªÅu lo·∫°i c√≥ th·ªÉ ch·ªçn).
* **DCA** theo **%Balance** + **Multiplier**, c√≥ **MaxLotPerSide ƒê·ªòNG** (base 1 lot, +0.1/1k$ balance tƒÉng).
* **ƒêo b·∫±ng POINTS** ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n (XAUUSD m·∫∑c ƒë·ªãnh **1 pip = 10 points**, **1 gi√° = 100 points**).
* **MinStop m·∫∑c ƒë·ªãnh 30 pip = 300 points**.
* **B·ªè SpreadMax filter** (nh∆∞ng c√≥ guard slippage/retry).
* **B·ªè Liquidity Sweep b·∫Øt bu·ªôc** - kh√¥ng require sweep tr∆∞·ªõc BOS.
* **FVG qu√©t ƒë·ªông** - gi√° t·ªõi ƒë√¢u qu√©t t·ªõi ƒë√≥, lo·∫°i b·ªè ƒë√£ ho√†n th√†nh.
* **Trailing SL b·∫Øt bu·ªôc** cho Momentum (ATR trail sau 1R).
* **Timezone**: Asia/Ho_Chi_Minh (ICT+7).
* **BOX visualization**: v·∫Ω v√† update real-time khi thay ƒë·ªïi.

## ‚úÖ **USER CONFIRMATIONS (2025-10-08)**

1. ‚úÖ K·∫øt h·ª£p c·∫£ 2 ph·∫ßn t√†i li·ªáu (ph∆∞∆°ng ph√°p ICT/SMC + Lifecycle management)
2. ‚úÖ FVG qu√©t ƒë·ªông theo gi√°, lo·∫°i b·ªè ƒë√£ ho√†n th√†nh
3. ‚úÖ Cho ph√©p nhi·ªÅu l·ªánh t·ª´ nhi·ªÅu POI
4. ‚úÖ ∆Øu ti√™n Momentum, b·∫Øt bu·ªôc trailing SL
5. ‚úÖ MaxLotPerSide ƒë·ªông: 1 lot base + 0.1/1k$ balance
6. ‚úÖ TP/SL chia nhi·ªÅu lo·∫°i c√≥ th·ªÉ ch·ªçn
7. ‚úÖ Timezone: Asia/Ho_Chi_Minh (ICT+7)
8. ‚úÖ BOX v·∫Ω chart v√† update real-time
10. ‚úÖ B·ªè Liquidity Sweep requirement

## üîÑ **UPDATE V4.1 (2025-10-08) - FIX "0 ENTRY" & OPTIMIZATION**

> **Based on**: `@update-config.md` - Chu·∫©n h√≥a ƒë∆°n v·ªã + Fix lifecycle ƒë·ªÉ c√≥ entry

### **1. Unit Converter System (CHU·∫®N H√ìA ƒê∆†N V·ªä)**

**Quy ∆∞·ªõc c·ªë ƒë·ªãnh:**
```
1 GI√Å = 10 PIP = 1,000 POINTS
```

**Implementation:**
- ‚úÖ `InpPointsPerPip = 100` (CHU·∫®N m·ªõi, thay v√¨ 10)
- ‚úÖ Enum `UNIT_POINTS | UNIT_PIPS | UNIT_GIA`
- ‚úÖ Functions: `PointsFromInput()`, `PriceDeltaToPoints()`, `PointsToPips()`, `PointsToGia()`
- ‚úÖ **T·∫§T C·∫¢ distance** ƒë·ªÅu normalize v·ªÅ **POINTS** tr∆∞·ªõc khi so s√°nh

**L√Ω do:** Tr√°nh nh·∫ßm l·∫´n gi·ªØa pip/gi√°/points ‚Üí logic sai ‚Üí no entry.

---

### **2. Session Filter - Fixed Timezone Conversion**

**V·∫•n ƒë·ªÅ:** So s√°nh server time tr·ª±c ti·∫øp v·ªõi ICT time (GMT+7) ‚Üí l·ªách m√∫i gi·ªù.

**Fix:**
- ‚úÖ Th√™m `InpBrokerGMTOffset` (auto-detect ho·∫∑c manual)
- ‚úÖ Function `ServerTimeToICT()` convert ƒë√∫ng c√°ch
- ‚úÖ Function `GetBrokerGMTOffset()` t·ª± ƒë·ªông detect ho·∫∑c d√πng input

**Logic:**
```
ICT_time = Server_time + (7 - BrokerOffset) hours
```

---

### **3. FVG Lifecycle - N·ªõi ƒêi·ªÅu Ki·ªán Entry**

**Changes:**
- ‚úÖ Cho ph√©p entry **C·∫¢ ACTIVE v√† PARTIAL** (tr∆∞·ªõc ch·ªâ ACTIVE)
- ‚úÖ `InpFVG_Fill_MinPct = 25%` (gi·∫£m t·ª´ 50% ‚Üí c·ª≠a s·ªï r·ªông h∆°n)
- ‚úÖ `InpFVG_MitigatePct = 65%` (tƒÉng t·ª´ 50% ‚Üí chuy·ªÉn PARTIAL s·ªõm h∆°n)
- ‚úÖ `InpFVG_CompletionPct = 85%` (gi·∫£m t·ª´ 95%)
- ‚úÖ `InpFVG_MinSizePts = 300` (0.3 gi√° - gi·ªØ nguy√™n)

**Code location:** `DetectSMCPullback()` - Check status

**L√Ω do:** FVG PARTIAL v·∫´n h·ª£p l·ªá cho entry, kh√¥ng n√™n lo·∫°i ra.

---

### **4. OB Touch Logic - Fixed "Gi√†" Qu√° Nhanh**

**V·∫•n ƒë·ªÅ:** `touch_count++` m·ªói bar close trong OB ‚Üí h·∫øt tu·ªïi th·ªç nhanh.

**Fix:**
- ‚úÖ Ch·ªâ tƒÉng `touch_count` khi **CROSS-IN** (t·ª´ ngo√†i v√†o trong)
- ‚úÖ Logic: `prev_close` ngo√†i range && `curr_close` trong range ‚Üí touch++
- ‚úÖ `InpOB_MaxTouches = 20` (tƒÉng t·ª´ 2 ‚Üí nhi·ªÅu c∆° h·ªôi h∆°n)
- ‚úÖ `InpOB_TTL_Bars = 240` (tƒÉng t·ª´ 200)

**Code location:** `UpdateOBStatus()` - Touch count logic

---

### **5. Momentum Freshness - Flexible**

**Changes:**
- ‚úÖ D√πng `InpMOMO_Fail_Bars` thay hardcode `< 5`
- ‚úÖ Default `InpMOMO_Fail_Bars = 4` (gi·∫£m t·ª´ 5)
- ‚úÖ `InpMinDispATR_Momo = 0.9` (gi·∫£m t·ª´ 1.2 ‚Üí d·ªÖ trigger h∆°n)

**Code location:** `DetectMomentumBreakout()` - Duplicate check

---

### **6. Enhanced Dashboard - Detailed Structures**

**New Features:**
- ‚úÖ Show chi ti·∫øt **t·ª´ng FVG/OB/Momentum** ƒëang wait
- ‚úÖ **[‚úì] Tick xanh** n·∫øu structure VALID cho entry
- ‚úÖ **[X]** n·∫øu expired/kh√¥ng h·ª£p l·ªá
- ‚úÖ Hi·ªÉn th·ªã: ID, price range, fill%, pullback%, age, ATR multiple

**Example Output:**
```
‚ïë WAITING STRUCTURES (Detailed):           ‚ïë
‚ïë [‚úì] FVG_L #12: 2548.5-2550.2 fill 35% ACT‚ïë
‚ïë [‚úì] FVG_S #18: 2552.0-2554.5 fill 10% ACT‚ïë
‚ïë [‚úì] OB_L #8: 2546.0-2548.0 pb 45% T:1/20 ‚ïë
‚ïë [X] MOMO_L #3: age 5 bars ATR 1.2x       ‚ïë
```

---

### **7. Updated Default Parameters**

| Parameter | Old | New | Reason |
|-----------|-----|-----|--------|
| `InpPointsPerPip` | 10 | **100** | Chu·∫©n h√≥a ƒë∆°n v·ªã |
| `InpFVG_Fill_MinPct` | 50% | **25%** | C·ª≠a s·ªï entry r·ªông h∆°n |
| `InpFVG_MitigatePct` | 50% | **65%** | Chuy·ªÉn PARTIAL s·ªõm |
| `InpFVG_CompletionPct` | 95% | **85%** | Ho√†n th√†nh s·ªõm h∆°n |
| `InpOB_MaxTouches` | 2 | **20** | Cross-in only |
| `InpOB_TTL_Bars` | 200 | **240** | Tu·ªïi th·ªç d√†i h∆°n |
| `InpMOMO_Fail_Bars` | (hardcode 5) | **4** | Flexible parameter |
| `InpMinDispATR_Momo` | 1.2 | **0.9** | D·ªÖ trigger |

---

### **8. Testing Checklist**

- [ ] Backtest 2 tu·∫ßn M5 XAUUSD ‚Üí c√≥ entry
- [ ] Session ON/OFF ‚Üí entry ƒë√∫ng gi·ªù
- [ ] FVG PARTIAL ‚Üí c√≥ entry
- [ ] OB touch count ‚Üí ch·ªâ tƒÉng khi cross-in
- [ ] Momentum age ‚Üí d√πng InpMOMO_Fail_Bars
- [ ] Dashboard ‚Üí show structures chi ti·∫øt
- [ ] Unit converter ‚Üí t·∫•t c·∫£ distances ƒë√∫ng

---

# 1) Decompose ‚Üí Plan ‚Üí ToT (scored) ‚Üí Reverse Thinking

## 1.1 Decompose

* **Market Filters**: Timezone Asia/Ho_Chi_Minh, session (ICT Killzone tu·ª≥ ch·ªçn, m·∫∑c ƒë·ªãnh OFF), News OFF (theo y√™u c·∫ßu), Slippage guard ON, MinStop clamp ON.
* **Entry**:

  * **SMC Pullback**: y√™u c·∫ßu **BOS (ƒë√≥ng c·ª≠a)** + **displacement**; v√πng **OB**/**FVG** h·ª£p l·ªá; Entry khi **pullback ƒë·∫øn OB ‚â• X%** ho·∫∑c **fill FVG ‚â• Y%** (c√≥ th·ªÉ th√™m **liquidity sweep** tr∆∞·ªõc ƒë√≥ ‚Äì optional).
  * **Momentum Breakout**: n·∫øn **ƒë√≥ng c·ª≠a** ph√° **SwingH/L** v·ªõi bi√™n ƒë·ªô **‚â• ATR*k** (displacement).
* **SL/TP**:

  * **Derive from Method** (m·∫∑c ƒë·ªãnh): SMC d√πng **StructureStop + buffer**, Momentum d√πng **SwingStop + buffer**, TP theo **Structure** ho·∫∑c **R-multiple** ph√π h·ª£p ph∆∞∆°ng ph√°p.
  * **Override FixedDistance** (tu·ª≥ ch·ªçn): nh·∫≠p **SL/TP theo pip/points**, auto quy ƒë·ªïi v·ªÅ **points**.
* **DCA Engine**: %Balance per add, **LotMultiplier**, **StepPoints**, **MinDistFromAvg**, **MaxOrders**, **MaxLotPerSide (Cap HARD/SOFT)**.
* **Basket Manager**: TP/SL theo **%Balance** (tu·ª≥ ch·ªçn), Daily loss limit, Timeout, Breach kill-switch.
* **Order/Exec**: magic isolation, one trade per bar, retry on reject, slippage guard, rounding lots theo `SYMBOL_VOLUME_STEP`.

## 1.2 Plan (chu·ªói x·ª≠ l√Ω)

1. **Collect context** (symbol digits/Point, session, ATR, swings, spread, slippage, positions hi·ªán t·∫°i).
2. **Sinh signal**: SMC + Momentum.
3. **Resolve**: n·∫øu c√πng chi·ªÅu ‚Üí h·ª£p nh·∫•t; n·∫øu ng∆∞·ª£c chi·ªÅu ‚Üí theo `ConflictPolicy` (m·∫∑c ƒë·ªãnh **NoTrade**).
4. **Ch·ªçn ph∆∞∆°ng ph√°p k√≠ch ho·∫°t** (SMC ho·∫∑c Momentum) ‚Üí **t√≠nh SL/TP** theo **Derive** ho·∫∑c **Override**.
5. **T√≠nh lot** theo %Risk v√† **Enforce MaxLotPerSide** (Cap HARD/SOFT).
6. **ƒê·∫∑t l·ªánh #1** (attach TP/SL).
7. **V√≤ng DCA**: theo StepPoints/MinDistFromAvg/Multiplier, v·∫´n **enforce cap**.
8. **Qu·∫£n tr·ªã basket**: partial, trailing, basket TP/SL theo %Balance, timeout/kill-switch.
9. **Journal** (log chu·∫©n ƒë·ªÉ debug & backtest).

## 1.3 ToT (2‚Äì3 ph∆∞∆°ng √°n) ‚Äì Ch·∫•m ƒëi·ªÉm

* **A) SMC-only + DCA nh·∫π** (Correctness 9 | Risk 5 | Cost/Time 6): ·ªïn khi th·ªã tr∆∞·ªùng mean-revert theo c·∫•u tr√∫c.
* **B) Momentum-only + DCA nh·∫π** (8 | 7 | 5): t·ªët khi trend r√µ; d·ªÖ whipsaw n·∫øu ATR th·∫•p.
* **C) Hybrid SMC+Momentum, `ConflictPolicy=NoTrade`** (**Recommended**) (9 | 6 | 7): ch·ªçn setup ‚Äúch·∫Øc tay‚Äù m·ªói th·ªùi ƒëi·ªÉm, gi·∫£m xung ƒë·ªôt.

## 1.4 Reverse Thinking (contrarian)

* **B·ªè Spread filter** + tin t·ª©c/rollover ‚áí **slippage spike**: b·∫Øt bu·ªôc `SlippageMax` + `RetryOnReject` + **NoTrade trong v√†i ph√∫t quanh rollover/news l·ªõn** (c·ªù optional).
* **DCA**: multiplier l·ªõn ho·∫∑c Step qu√° nh·ªè ‚áí **DD ph√¨nh**; gi·ªØ Multiplier **1.05‚Äì1.15**, Step **‚â• 1500‚Äì2500 points**, **MaxOrders ‚â§ 6‚Äì7**.
* **MinStop clamp 300 points**: n·∫øu c·∫•u tr√∫c g·ª£i √Ω SL < 300 ‚áí **clamp** tr√°nh **stop qu√° s√°t**.

---

# 2) Glossary (ƒë·ªãnh nghƒ©a c√≥ th·ªÉ code)

| Term                         | ƒê·ªãnh nghƒ©a l·∫≠p tr√¨nh (codeable)                                                                                                                               |            |                                |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------------------ |
| **SwingH/L**                 | **Fractal depth k** (m·∫∑c ƒë·ªãnh `k=2`): SwingH l√† ƒë·ªânh m√† **High[i] > High[i-1..i-k] v√† High[i] ‚â• High[i+1..i+k]**. SwingL t∆∞∆°ng t·ª± cho Low.                    |            |                                |
| **BOS (Break of Structure)** | N·∫øn **Close** v∆∞·ª£t qua **SwingH/L g·∫ßn nh·∫•t** theo h∆∞·ªõng ƒëang x√©t **+ buffer (0 points)**, k√®m **displacement**: `TrueRange(EntryBar) ‚â• ATR(14) * MinDispATR`. |            |                                |
| **Displacement**             | `TrueRange` ho·∫∑c `                                                                                                                                            | Close-Open | `c·ªßa n·∫øn ph√°, so v·ªõi`ATR(14)`. |
| **Order Block (OB)**         | N·∫øn **ng∆∞·ª£c chi·ªÅu** cu·ªëi c√πng **tr∆∞·ªõc** c√∫ ƒë·∫©y t·∫°o BOS. Bi√™n v√πng = **High/Low** n·∫øn ƒë√≥ (tu·ª≥ Buy/Sell). Tu·ª≥ ch·ªçn **Refine body**: bi√™n trong = Open/Close.    |            |                                |
| **FVG (3-candle)**           | Kho·∫£ng tr·ªëng: **Low(candle2) > High(candle0)** (up) ho·∫∑c **High(candle2) < Low(candle0)** (down). `FVG_MinSizePts` m·∫∑c ƒë·ªãnh **300 points**.                   |            |                                |
| **Liquidity Sweep/Grab**     | High/Low v·ª´a **qu√©t** qua m·ªôt SwingH/L li·ªÅn tr∆∞·ªõc **r·ªìi ƒë√≥ng quay ƒë·∫ßu**, x√°c nh·∫≠n b·∫±ng wick/close; optional filter.                                           |            |                                |
| **Killzone (ICT)**           | Khung gi·ªù phi√™n √Å/√Çu/M·ªπ (ƒë·ªïi sang ICT+7). M·∫∑c ƒë·ªãnh **OFF** ƒë·ªÉ kh√¥ng h·∫°n ch·∫ø entry.                                                                            |            |                                |
| **Price/Pip/Point** (XAUUSD) | `_Point` th∆∞·ªùng = **0.01**. **1 pip = 10 points**, **1 gi√° = 100 points**. `PointsPerPip=10`.                                                                 |            |                                |

---

# 3) Logic Entry ‚Üí SL/TP chi ti·∫øt

## 3.1 SMC Pullback

**ƒêi·ªÅu ki·ªán h·ª£p l·ªá**

1. **BOS (close)** qua SwingH/L g·∫ßn nh·∫•t **+ displacement**:

   * `MinDispATR_SMC = 1.0` (range n·∫øn ph√° ‚â• 1.0 √ó ATR(14)).
   * `BOS_FractalK = 2` (config).
2. **V√πng ph·∫£n ·ª©ng** c√≥ √≠t nh·∫•t **1** trong 2:

   * **OB** h·ª£p l·ªá (the last opposite candle before impulse).
   * **FVG** 3-candle c√≥ size ‚â• `FVG_MinSizePts = 300`.
3. **Trigger** (tho·∫£ **1**):

   * Pullback v√†o **OB** ƒë·∫°t `OB_Pullback_MinPct = 25%` ƒë·ªô d√†y OB (t·ª´ m√©p ngo√†i v√†o).
   * **FVG fill** ƒë·∫°t `FVG_Fill_MinPct = 50%`.

**Entry**

* **Buy**: sau BOS-up, trigger t·∫°i **pullback** v√†o OB/FVG theo rule tr√™n.
* **Sell**: ng∆∞·ª£c l·∫°i.

**Stop Loss (SMC)**

* **StructureStop**: ƒë·∫∑t **ngo√†i m√©p v√πng** (ƒë√°y OB ƒë·ªëi v·ªõi Buy / ƒë·ªânh OB ƒë·ªëi v·ªõi Sell) **+ SLBufferPts**.
* **Clamp**: `SL ‚â• MinStopPointsClamp` (m·∫∑c ƒë·ªãnh **300 points**).

**TP & Qu·∫£n tr·ªã**

* **TP1**: **mid-FVG** (n·∫øu c√≥) **ho·∫∑c 1R** (khi b·∫≠t R-multiple).
* **TP2**: **m√©p ƒë·ªëi di·ªán v√πng** (OB/FVG) **ho·∫∑c 2R**.
* **Trailing**: **Structure-trail** theo HL/LH m·ªõi h√¨nh th√†nh; `TrailStepMinPts = 300`.

> ~~**Optional (tƒÉng x√°c su·∫•t)**: y√™u c·∫ßu **Liquidity Sweep** x·∫£y ra ngay tr∆∞·ªõc BOS; n·∫øu b·∫≠t, ch·ªâ cho ph√©p entry khi c√≥ sweep.~~ ‚Üí **B·ªé** (confirmed - kh√¥ng b·∫Øt bu·ªôc Liquidity Sweep).

## 3.2 Momentum Breakout

**ƒêi·ªÅu ki·ªán h·ª£p l·ªá**

* N·∫øn **ƒë√≥ng c·ª≠a** **tr√™n SwingH** (Buy) / **d∆∞·ªõi SwingL** (Sell), v√†
* **Displacement**: `TrueRange(BarBreakout) ‚â• ATR(14) * MinDispATR_Momo`, v·ªõi `MinDispATR_Momo = 1.2`.

**Entry**

* **Market** t·∫°i close n·∫øn ph√° (ho·∫∑c **Stop** t·∫°i SwingH/L ¬± buffer n·∫øu mu·ªën ch·ªëng slip ‚Äì optional).

**Stop Loss (Momentum)**

* **SwingStop** sau Swing b·ªã ph√° **+ SLBufferPts**; **Clamp ‚â• 300 points**.

**TP & Trailing**

* **R-multiple** m·∫∑c ƒë·ªãnh: **TP1 = 1R** (partial 30‚Äì50%), **TP2 = 2R**.
* Khi ƒë·∫°t **1R**, b·∫≠t **ATR-trail** (`ATR_Period=14`, `ATR_Mult=2.0`, `TrailStepMinPts=300`).

## 3.3 Conflict Handling (khi b·∫≠t c·∫£ 2 ph∆∞∆°ng ph√°p)

* **C√πng chi·ªÅu**: h·ª£p nh·∫•t, **∆ØU TI√äN MOMENTUM** (confirmed by user). Momentum c√≥ trailing SL b·∫Øt bu·ªôc.
* **Ng∆∞·ª£c chi·ªÅu**: theo `ConflictPolicy` (m·∫∑c ƒë·ªãnh **NoTrade**). Tu·ª≥ ch·ªçn `PreferTrend` (nh√¨n bias c·ªßa ATR slope/HTF).
* **TRAILING SL**: Khi Momentum active, **B·∫ÆT BU·ªòC** ph·∫£i k√©o SL theo (ATR trail sau khi ƒë·∫°t 1R).

---

# 4) SL/TP theo pip/points (Override)

## 4.1 C·∫•u h√¨nh

* `DistanceUnit` = {`POINTS`,`PIPS`} (m·∫∑c ƒë·ªãnh **POINTS**).
* `PointsPerPip` (XAUUSD m·∫∑c ƒë·ªãnh **10**).
* `SLTP_DeriveFromMethod` (m·∫∑c ƒë·ªãnh **true**).
* `SLTP_Override_Mode` = {`Structure`,`RMultiple`,`FixedDistance`} (k√≠ch ho·∫°t khi `Derive=false`).
* `SL_FixedDist`, `TP_FixedDist` (ƒë∆°n v·ªã theo `DistanceUnit`).

## 4.2 Quy ƒë·ªïi & √°p d·ª•ng

```text
if DistanceUnit == PIPS:
    dist_points = round(value * PointsPerPip)
else:
    dist_points = round(value)

Price calc (BUY):
SL = Entry - dist_points * _Point
TP = Entry + dist_points * _Point
(Sell ng∆∞·ª£c l·∫°i)
```

* **Derive=true**: theo **ph∆∞∆°ng ph√°p Entry**.
* **Derive=false + FixedDistance**: √©p SL/TP c·ªë ƒë·ªãnh (v√≠ d·ª• SL=50 pip ‚Üí 500 points, TP=100 pip ‚Üí 1000 points) **cho m·ªçi Entry**.
* V·∫´n √°p **Clamp MinStopPointsClamp** (‚â• 300).

---

# 5) DCA Engine

## 5.1 Lu·∫≠t add l·ªánh

* **EnableDCA=true**, **MaxOrders=6** (bao g·ªìm l·ªánh #1).
* **StepPoints=2000** (kho·∫£ng c√°ch gi·ªØa Gi√° hi·ªán t·∫°i ƒë·∫øn **Average Entry** ho·∫∑c ƒë·∫øn **l·∫ßn add g·∫ßn nh·∫•t** ‚Äì ch·ªçn b·∫±ng `DCA_StepMode`).
* **MinDistFromAvg=1000**: kh√¥ng add n·∫øu kho·∫£ng c√°ch ƒë·∫øn **Average** < 1000 points.
* **Confluence requirement (tu·ª≥ ch·ªçn)**: ch·ªâ add khi c√≤n gi·ªØ **bias ban ƒë·∫ßu** (kh√¥ng b·ªã BOS ng∆∞·ª£c).

## 5.2 Sizing m·ªói add

* **BaseRiskPct_PerAdd = 0.10%** Balance.
* Quy ƒë·ªïi **%risk ‚Üí lots** d·ª±a tr√™n **StopPoints hi·ªán h√†nh** (t√≠nh t·ª´ **ph∆∞∆°ng ph√°p ƒëang ch·∫°y**).
* √Åp **LotMultiplier** (m·∫∑c ƒë·ªãnh **1.10**) theo s·ªë th·ª© t·ª± add.
* **Enforce MaxLotPerSide** (xem 6.2).

---

# 6) Risk/Exec/Order Management

## 6.1 Guard chung

* **MinStopPointsClamp = 300** (30 pip).
* **SlippageMaxPoints = 120**; n·∫øu >120 points: **RetryOnReject** (t·ªëi ƒëa 2 l·∫ßn v·ªõi delay 200‚Äì500ms).
* **One trade per bar** (ch·ªëng spam).
* **NoTrade windows** (optional): ¬±X ph√∫t quanh rollover (EOD) / major news (n·∫øu sau b·∫≠t NewsFilter).

## 6.1b Session Filter & Time Management (CONFIRMED)

* **EnableSessionFilter** (m·∫∑c ƒë·ªãnh **OFF**): kh√¥ng h·∫°n ch·∫ø gi·ªù trade.
* **3 Custom Sessions** c√≥ th·ªÉ config:
  * Session 1: `08:00‚Äì11:30` (GMT+7) - Asian overlap
  * Session 2: `14:00‚Äì17:00` (GMT+7) - London open
  * Session 3: `19:00‚Äì23:30` (GMT+7) - NY session
* **Timezone**: Asia/Ho_Chi_Minh (GMT+7) - c·ªë ƒë·ªãnh.
* **Rollover Filter**: Ch·∫∑n entry ¬±5 ph√∫t quanh `00:00` broker time (tr√°nh spike spread/slippage).
* **H√†nh vi ngo√†i session**:
  * **KH√îNG** m·ªü l·ªánh m·ªõi (entry).
  * **V·∫™N** qu·∫£n l√Ω l·ªánh ƒëang c√≥ (trailing, DCA, basket TP/SL, timeout).
  * **KH√îNG** ƒë√≥ng l·ªánh c≈© khi h·∫øt session.

## 6.2 MaxLotPerSide (config) - ƒê·ªòNG THEO BALANCE

* `MaxLotPerSide_Base = 1.00` (m·∫∑c ƒë·ªãnh khi balance = initial).
* **C√îNG TH·ª®C ƒê·ªòNG**: `MaxLotPerSide = Base + floor((Balance - InitialBalance) / 1000) * 0.1`
  * V√≠ d·ª•: Balance tƒÉng 1000$ ‚Üí +0.1 lot; tƒÉng 2500$ ‚Üí +0.2 lot.
* `CapMode = SOFT` (recommend) | `HARD`.
* `OnMaxLotExceededAction = ReduceToFit` | `BlockAdds` | `Flatten` (√≠t khuy·∫øn ngh·ªã).

**H√†nh vi**

* **SOFT/ReduceToFit**: c·∫Øt `LotsNew` ƒë·ªÉ kh√¥ng v∆∞·ª£t tr·∫ßn; n·∫øu < `SYMBOL_VOLUME_MIN` th√¨ **b·ªè add**.
* **HARD/BlockAdds**: ch·∫∑n m·ªü th√™m khi v∆∞·ª£t tr·∫ßn.

## 6.3 Basket Manager (tu·ª≥ ch·ªçn)

* **BasketTP_PctBalance** = 0.3% (ƒë·ªÅ xu·∫•t).
* **BasketSL_PctBalance** = 1.2% (ƒë·ªÅ xu·∫•t).
* **DailyLossLimit_PctBalance** (v√≠ d·ª• 2‚Äì3%): khi ch·∫°m ‚Üí **BREACH**: d·ª´ng giao d·ªãch ƒë·∫øn h·∫øt ng√†y theo timezone **ICT+7**.
* **TimeoutMins**: ƒë√≥ng to√†n basket n·∫øu qu√° l√¢u m√† ch∆∞a ƒë·∫°t target (tr√°nh ‚Äúk·∫πt l·ªánh‚Äù).

## 6.4 Th·ª±c thi & K·ªπ thu·∫≠t kh·ªõp

* **MagicNumber** theo c·∫∑p/method ƒë·ªÉ isolate.
* **Hedging mode**: nhi·ªÅu v·ªã th·∫ø c√πng chi·ªÅu ƒë∆∞·ª£c ph√©p.
* **R√†ng bu·ªôc broker**: `SYMBOL_VOLUME_MIN/STEP/MAX`, `SYMBOL_TRADE_TICK_SIZE`, `MODE_STOPLEVEL`.
* **Rounding**: lots ‚Üí `SYMBOL_VOLUME_STEP`, gi√° ‚Üí theo `_Point`.

## 6.5 On-Screen Dashboard (Real-time Monitor)

**M·ª•c ƒë√≠ch**: Hi·ªÉn th·ªã tr·∫°ng th√°i EA real-time tr√™n chart ƒë·ªÉ d·ªÖ monitor khi test/trade.

**N·ªôi dung Dashboard (Comment ho·∫∑c Label panel):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ OAT_V4 - ICT/SMC + Momentum EA              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ STATE: ACTIVE_BASKET | SCAN | IDLE          ‚îÇ
‚îÇ Balance: $10,250.00 | MaxLot: 1.02          ‚îÇ
‚îÇ Floating P/L: +$45.50 (+0.44%)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ SESSION FILTER: [‚úì] ON | [ ] OFF            ‚îÇ
‚îÇ   Current: 15:30 (GMT+7)                    ‚îÇ
‚îÇ   Status: [‚úì] IN SESSION (London)           ‚îÇ
‚îÇ   Rollover: [ ] BLOCKED                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ACTIVE POI (Point of Interest):             ‚îÇ
‚îÇ ‚îú‚îÄ FVG LONG:  2 active | 1 partial          ‚îÇ
‚îÇ ‚îÇ   #12: 2548.5-2550.2 (fill 35%)           ‚îÇ
‚îÇ ‚îÇ   #15: 2545.0-2547.5 (fill 62%) PARTIAL   ‚îÇ
‚îÇ ‚îú‚îÄ FVG SHORT: 1 active                      ‚îÇ
‚îÇ ‚îÇ   #18: 2552.0-2554.5 (fill 10%)           ‚îÇ
‚îÇ ‚îú‚îÄ OB LONG:   1 active                      ‚îÇ
‚îÇ ‚îÇ   #8: 2546.0-2548.0 (pb 45%, touch 1/2)   ‚îÇ
‚îÇ ‚îî‚îÄ MOMO:      1 LONG active (age 3 bars)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ SIGNALS:                                    ‚îÇ
‚îÇ ‚îú‚îÄ SMC:       [‚úì] VALID - FVG#15 fill 62%   ‚îÇ
‚îÇ ‚îî‚îÄ MOMENTUM:  [ ] NONE                      ‚îÇ
‚îÇ ‚Üí RESOLVED:   SMC LONG (Momentum priority)  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ POSITIONS:                                  ‚îÇ
‚îÇ ‚îú‚îÄ LONG:  2 orders | 0.15 lots | Avg 2547.5 ‚îÇ
‚îÇ ‚îÇ   #1: 0.10 @ 2548.0 | SL 2545.0 | +$12    ‚îÇ
‚îÇ ‚îÇ   #2: 0.05 @ 2546.0 | SL 2543.0 | +$8     ‚îÇ
‚îÇ ‚îî‚îÄ SHORT: 0 orders                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ DCA STATUS:                                 ‚îÇ
‚îÇ ‚îú‚îÄ Next Add: 800 pts from avg (need 1500)  ‚îÇ
‚îÇ ‚îú‚îÄ Orders: 2/5 | Step: 1500 pts             ‚îÇ
‚îÇ ‚îî‚îÄ Lot Cap: 0.15/1.02 (14.7% used)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ BASKET LIMITS:                              ‚îÇ
‚îÇ ‚îú‚îÄ TP: +0.50% ($51.25) | Current: +0.44%    ‚îÇ
‚îÇ ‚îú‚îÄ SL: -0.80% ($82.00) | Current: +0.44%    ‚îÇ
‚îÇ ‚îî‚îÄ Daily Limit: -1.20% | Today: -0.15%      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TRAILING:                                   ‚îÇ
‚îÇ ‚îú‚îÄ MOMO #1: [‚úì] ACTIVE (profit 1.2R)        ‚îÇ
‚îÇ ‚îÇ   ATR Trail: SL moved 350 pts             ‚îÇ
‚îÇ ‚îî‚îÄ SMC: Breakeven mode                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ LAST ACTION:                                ‚îÇ
‚îÇ 15:28:45 - ORDER_PLACED: LONG 0.10 @ 2548.0 ‚îÇ
‚îÇ 15:29:12 - TRAILING_SL: Ticket 123456 moved ‚îÇ
‚îÇ 15:30:00 - SESSION_CHECK: In session ‚úì      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Update frequency**: M·ªói tick (ho·∫∑c m·ªói gi√¢y ƒë·ªÉ tr√°nh lag).

**V·ªã tr√≠**: G√≥c tr√°i tr√™n chart (c√≥ th·ªÉ config).

**Format**:
- **Comment()**: ƒê∆°n gi·∫£n, nhanh.
- **Label Objects**: ƒê·∫πp h∆°n, custom ƒë∆∞·ª£c font/color.

**M√†u s·∫Øc**:
- ‚úÖ Green: Active/Valid/Profit
- ‚ùå Red: Blocked/Invalid/Loss
- ‚ö†Ô∏è Yellow: Warning/Partial
- ‚ö™ Gray: Idle/Neutral

---

# 7) B·∫£ng tham s·ªë (type, default, min/max, l√Ω do)

> **L∆∞u √Ω**: **POINTS** tr·ª´ khi ghi r√µ PIPS.

| Nh√≥m         | T√™n tham s·ªë            | Type   |          Default |                           Min/Max | [Why]                       |
| ------------ | ---------------------- | ------ | ---------------: | --------------------------------: | --------------------------- |
| General      | Timezone               | string | Asia/Ho_Chi_Minh |                                 ‚Äî | ƒê·ªìng b·ªô phi√™n/nh·∫≠t k√Ω.      |
| General      | OneTradePerBar         | bool   |             true |                                 ‚Äî | Anti-spam.                  |
| Entry.Common | BOS_FractalK           | int    |                2 |                               1‚Äì4 | ·ªîn swing.                   |
| Entry.Common | ATR_Period             | int    |               14 |                             10‚Äì20 | Chu·∫©n displacement/trail.   |
| SMC          | MinDispATR_SMC         | double |              1.0 |                           0.8‚Äì2.0 | L·ªçc ph√° y·∫øu.                |
| SMC          | FVG_MinSizePts         | int    |              300 |                           150‚Äì600 | Tr√°nh gap nhi·ªÖu.            |
| SMC          | OB_Pullback_MinPct     | %      |               25 |                             10‚Äì60 | Pullback ‚Äúƒë√£ v√†o v√πng‚Äù.     |
| SMC          | FVG_Fill_MinPct        | %      |               50 |                             25‚Äì80 | Fill ƒë·ªß s√¢u.                |
| MOMO         | MinDispATR_Momo        | double |              1.2 |                           1.0‚Äì2.5 | Ch·ªëng false break.          |
| SL/TP        | SLTP_DeriveFromMethod  | bool   |             true |                                 ‚Äî | Gi·ªØ semantics ph∆∞∆°ng ph√°p.  |
| SL/TP        | DistanceUnit           | enum   |           POINTS |                       PIPS/POINTS | Linh ho·∫°t input.            |
| SL/TP        | PointsPerPip           | int    |               10 |                              5‚Äì20 | XAU m·∫∑c ƒë·ªãnh 10.            |
| SL/TP        | SLTP_Override_Mode     | enum   |        Structure | Structure/RMultiple/FixedDistance | Khi `Derive=false`.         |
| SL/TP        | SL_FixedDist           | double |              500 |                          150‚Äì3000 | 50 pip = 500 pts.           |
| SL/TP        | TP_FixedDist           | double |             1000 |                          300‚Äì6000 | 100 pip = 1000 pts.         |
| SL/TP        | SLBufferPts            | int    |              300 |                           200‚Äì600 | Tr√°nh qu√©t s√°t v√πng.        |
| SL/TP        | MinStopPointsClamp     | int    |              300 |                              ‚â•300 | Y√™u c·∫ßu 30 pip.             |
| Trail        | TrailStepMinPts        | int    |              300 |                           200‚Äì600 | Gi·∫£m whipsaw.               |
| MOMO Trail   | ATR_Mult               | double |              2.0 |                           1.5‚Äì3.0 | Theo bi·∫øn ƒë·ªông.             |
| DCA          | EnableDCA              | bool   |             true |                                 ‚Äî | B·∫≠t DCA.                    |
| DCA          | MaxOrders              | int    |                6 |                              2‚Äì10 | Ki·ªÉm so√°t DD.               |
| DCA          | StepPoints             | int    |             2000 |                         1000‚Äì3000 | Nh·ªãp DCA.                   |
| DCA          | MinDistFromAvg         | int    |             1000 |                          500‚Äì3000 | Tr√°nh add s√°t.              |
| DCA          | BaseRiskPct_PerAdd     | %Bal   |            0.10% |                        0.05‚Äì0.30% | Ki·ªÉm so√°t risk/add.         |
| DCA          | LotMultiplier          | double |             1.10 |                         1.00‚Äì1.20 | Tr√°nh ph√¨nh lot.            |
| DCA          | MaxLotPerSide          | lots   |             5.00 |                           ‚â•VolMin | Tr·∫ßn an to√†n.               |
| DCA          | CapMode                | enum   |             SOFT |                         HARD/SOFT | SOFT gi·∫£m lots ƒë·ªÉ v·ª´a tr·∫ßn. |
| DCA          | OnMaxLotExceededAction | enum   |      ReduceToFit |                 BlockAdds/Flatten | H√†nh vi khi v∆∞·ª£t tr·∫ßn.      |
| Basket       | BasketTP_PctBalance    | %Bal   |             0.3% |                          0.1‚Äì1.0% | Kho√° l·ª£i nhu·∫≠n.             |
| Basket       | BasketSL_PctBalance    | %Bal   |             1.2% |                          0.5‚Äì3.0% | B·∫£o v·ªá t√†i kho·∫£n.           |
| Exec         | SlippageMaxPoints      | int    |              120 |                            50‚Äì200 | Ch·∫•t l∆∞·ª£ng kh·ªõp.            |
| Exec         | RetryOnReject          | int    |                2 |                               0‚Äì3 | ƒê·ªô b·ªÅn ƒë·∫∑t l·ªánh.            |
| Session      | EnableSessionFilter    | bool   |            false |                                 ‚Äî | B·∫≠t l·ªçc gi·ªù trade (OFF).    |
| Session      | Session1_Start         | string |          "08:00" |                                 ‚Äî | Session 1 start (GMT+7).    |
| Session      | Session1_End           | string |          "11:30" |                                 ‚Äî | Session 1 end.              |
| Session      | Session2_Start         | string |          "14:00" |                                 ‚Äî | Session 2 start.            |
| Session      | Session2_End           | string |          "17:00" |                                 ‚Äî | Session 2 end.              |
| Session      | Session3_Start         | string |          "19:00" |                                 ‚Äî | Session 3 start.            |
| Session      | Session3_End           | string |          "23:30" |                                 ‚Äî | Session 3 end.              |
| Session      | RolloverFilterMins     | int    |                5 |                               0‚Äì15 | Ch·∫∑n ¬±X ph√∫t quanh 00:00.   |

---

# 8) State machine (m√¥ t·∫£ vƒÉn b·∫£n)

`IDLE ‚Üí SCAN ‚Üí RESOLVE ‚Üí PENDING_ENTRY ‚Üí ACTIVE_BASKET ‚Üí (ADD_OK | PARTIAL | TRAILING | BASKET_TP | BASKET_SL | TIMEOUT) ‚Üí EXITED`

* **IDLE**: ch·ªù tick/ƒëi·ªÅu ki·ªán th·ªùi gian.
* **SCAN**: t√≠nh swings/ATR/BOS/OB/FVG/momentum signals.
* **RESOLVE**: x·ª≠ l√Ω xung ƒë·ªôt SMC vs Momentum.
* **PENDING_ENTRY**: ch·ªù bar close/confirm (n·∫øu c·∫•u h√¨nh).
* **ACTIVE_BASKET**: ƒë√£ c√≥ l·ªánh; theo d√µi DCA, partial, trailing, basket TP/SL, breach.
* **EXITED**: kh√¥ng c√≤n v·ªã th·∫ø; ƒëi journal & quay l·∫°i IDLE.
* **BREACH (global)**: khi DailyLossLimit/breach kh√°c ‚Üí d·ª´ng v√†o l·ªánh ƒë·∫øn h·∫øt ng√†y.

---

# 9) Pseudocode (tri·ªÉn khai module)

```pseudocode
// ==== UNIT HELPERS ====
ToPoints(v, unit, ppp=10):
    return (unit == PIPS) ? round(v * ppp) : round(v)

PriceFromPoints(entry, pts, dir, isSL):
    if dir == BUY:
        return entry - pts*_Point if isSL else entry + pts*_Point
    else:
        return entry + pts*_Point if isSL else entry - pts*_Point

// ==== SIGNALS ====
DetectSwings(fractal_k):
    // tr·∫£ v·ªÅ danh s√°ch SwingH/L ch·ªâ s·ªë + gi√°
DetectBOS(fractal_k, atr_period, min_disp_atr):
    // n·∫øn Close ph√° Swing k√®m TrueRange >= ATR*min_disp_atr
DetectOBFVG(...):
    // OB: last opposite candle tr∆∞·ªõc impulse; FVG: gap 3-candle >= FVG_MinSizePts

BuildSignal_SMC():
    if !BOS.valid: return NONE
    zone = Pick(OB or FVG) if meets size rules
    trigger = PullbackToOB>=OB_Pullback_MinPct or FVG_Fill>=FVG_Fill_MinPct
    if trigger: return {dir, method:SMC, zone, bos_bar}

BuildSignal_MOMO():
    if Close crosses SwingH/L and TR >= ATR*MinDispATR_Momo:
        return {dir, method:MOMO, swing}

// ==== RESOLVE ====
ResolveSignals(s_smc, s_momo):
    if s_smc.nil and s_momo.nil: return NONE
    if both and same dir: return prioritize(MethodPriority)
    if both and opposite dir: apply ConflictPolicy (NoTrade/PreferTrend/PreferSMC/PreferMOMO)
    else return the existing one

// ==== SL/TP ====
ComputeSLTP(signal, entry_price):
    if SLTP_DeriveFromMethod:
        if signal.method == SMC:
            sl_pts = max( StructureStopPts(signal.zone) + SLBufferPts, MinStopPointsClamp )
            (tp1_pts, tp2_pts) = StructureTargetsPts(signal.zone) or (RtoPts(1), RtoPts(2))
        else: // MOMO
            sl_pts = max( SwingStopPts(signal.swing) + SLBufferPts, MinStopPointsClamp )
            (tp1_pts, tp2_pts) = (RtoPts(1), RtoPts(2))
    else:
        sl_pts = ToPoints(SL_FixedDist, DistanceUnit, PointsPerPip)
        tp1_pts = ToPoints(TP_FixedDist, DistanceUnit, PointsPerPip)
        tp2_pts = tp1_pts // or 2*tp1_pts if configured

    SL = PriceFromPoints(entry_price, sl_pts, signal.dir, isSL=true)
    TP1 = PriceFromPoints(entry_price, tp1_pts, signal.dir, isSL=false)
    TP2 = PriceFromPoints(entry_price, tp2_pts, signal.dir, isSL=false)
    return (SL, TP1, TP2, sl_pts)

// ==== LOTS & CAP ====
LotsByRiskPct(balance, risk_pct, stop_pts):
    money_risk = balance * risk_pct
    // value_per_point = TickValue per point (dev d√πng SymbolInfoDouble calculations)
    lots = money_risk / (stop_pts * value_per_point)
    return RoundToVolumeStep(lots)

EnforceMaxLotPerSide(side, lots_new):
    if MaxLotPerSide <= 0: return lots_new
    lots_side = SumOpenLots(side)
    if lots_side + lots_new <= MaxLotPerSide: return lots_new

    if CapMode == HARD:
        return 0 if OnMaxLotExceededAction == BlockAdds else 0 // Flatten optional
    else: // SOFT
        allow = MaxLotPerSide - lots_side
        adj = RoundToVolumeStep(max(0, allow))
        return (adj >= SYMBOL_VOLUME_MIN) ? adj : 0

// ==== PLACE FIRST ORDER ====
PlaceFirstOrder(signal):
    entry = GetEntryPrice(signal) // market at close or limit at zone edge
    (SL, TP1, TP2, sl_pts) = ComputeSLTP(signal, entry)
    lots_raw = LotsByRiskPct(AccountBalance(), BaseRiskPct_PerAdd, sl_pts)
    lots = EnforceMaxLotPerSide(signal.dir, lots_raw)
    if lots <= 0: return FAIL("Lot cap")
    SendOrder(signal.dir, lots, entry, SL, TP1) // TP2 via separate order or virtual
    SetState(ACTIVE_BASKET)

// ==== DCA ADD ====
MaybeAddDCA(signal):
    if !EnableDCA or OrdersCount(signal.side) >= MaxOrders: return
    if DistanceToAvg(signal.side) < MinDistFromAvg: return
    if DistanceToLastAdd(signal.side) < StepPoints: return
    lots_raw = LotsByRiskPct(AccountBalance(), BaseRiskPct_PerAdd, sl_pts) * pow(LotMultiplier, AddIndex(signal.side))
    lots = EnforceMaxLotPerSide(signal.side, lots_raw)
    if lots > 0: SendAdd(signal.dir, lots)

// ==== BASKET MANAGER ====
ManageBasket():
    if BasketTP_PctBalance>0 and FloatingPLPct() >= BasketTP_PctBalance: CloseAllSide()
    if BasketSL_PctBalance>0 and FloatingPLPct() <= -BasketSL_PctBalance: CloseAllSide()
    if TimeoutMins>0 and ElapsedSinceEntry() >= TimeoutMins: CloseAllSide()

// ==== TRAILING ====
DoTrailing(signal):
    if signal.method == MOMO and Reached1R:
        ATRTrail(ATR_Period, ATR_Mult, TrailStepMinPts)
    if signal.method == SMC:
        StructureTrail(TrailStepMinPts)

// ==== MAIN LOOP ====
OnTick():
    if Breach(): return
    if OneTradePerBar and NewBar():
        s_smc = BuildSignal_SMC()
        s_momo = BuildSignal_MOMO()
        s = ResolveSignals(s_smc, s_momo)
        if s: PlaceFirstOrder(s)
    if InActiveBasket(): 
        MaybeAddDCA(s)
        DoTrailing(s)
        ManageBasket()
```

---

# 10) V√≠ d·ª• s·ªë (XAUUSD)

* **V√≠ d·ª• 1 ‚Äì SMC Pullback (Buy)**
  Entry t·∫°i **2,550.00**; OB ƒë√°y **2,547.00** ‚áí d√†y OB = **300 points**; `SLBuffer=300`.
  ‚Üí **StructureStop**: d∆∞·ªõi m√©p OB **300 pts** n·ªØa ‚áí **SL = 2,546.70** (Clamp ‚â• 300 ok).
  N·∫øu `Derive=false`, `SL_FixedDist=50 pip` ‚áí **500 points** ‚áí **SL = 2,545.00**.

* **V√≠ d·ª• 2 ‚Äì Momentum (Buy)**
  Close ph√° SwingH v·ªõi range = **1.4√óATR(14)** (‚â•1.2 h·ª£p l·ªá).
  `SL` sau Swing + **300 pts**; **TP1=1R** (partial 40%), **TP2=2R**; ƒë·∫°t 1R th√¨ **ATR-trail** (14, 2.0, step 300).

* **V√≠ d·ª• 3 ‚Äì DCA Cap m·ªÅm**
  `MaxLotPerSide=5.00`, ƒëang c√≥ **3.40 lots (Buy)**. DCA ƒë·ªÅ xu·∫•t **2.00** ‚áí cho ph√©p **1.60** (round theo step 0.01) ‚Üí **1.60 lots**.

---

# 11) Backtest & Optimization Protocol

* **Data window**: 12‚Äì24 th√°ng g·∫ßn nh·∫•t; XAUUSD **M5** (m·∫∑c ƒë·ªãnh), so s√°nh **M15**.
* **WFO**: chia **70/30** theo qu√Ω; t·ªëi ∆∞u ph·∫°m vi:

  * `MinDispATR_SMC ‚àà [0.8..1.6]`, `MinDispATR_Momo ‚àà [1.0..1.8]`,
  * `OB_Pullback_MinPct ‚àà [15..45]`, `FVG_Fill_MinPct ‚àà [35..65]`,
  * `StepPoints ‚àà [1500..3000]`, `LotMultiplier ‚àà [1.05..1.15]`, `MaxOrders ‚àà [4..7]`.
* **Reject overfit** n·∫øu PF tr√™n train >> test (>30%), #trades/test < 200, ho·∫∑c DD test > 1.5√ó DD train.
* **KPI**: PF‚â•1.3 test, Winrate‚â•48% (momo) / ‚â•52% (smc), Expectancy>0, MaxDD ‚â§ 12%, #trades ‚â• 200/6mo.

---

# 12) Test Cases & Edge Cases

* **Digits/Point kh√°c th∆∞·ªùng**: ki·ªÉm tra `SymbolInfoDouble(_Point)`; `PointsPerPip` auto theo XAU = 10 (allow override).
* **MODE_STOPLEVEL** cao: n·∫øu SL/TP < stop level ‚Üí chuy·ªÉn sang **virtual SL/TP** + **CloseOnTouch**.
* **Slippage spike**: v∆∞·ª£t `SlippageMaxPoints` ‚áí retry 2 l·∫ßn; n·∫øu v·∫´n fail ‚áí **ABORT**.
* **Partial fills/Reject**: log ƒë·∫ßy ƒë·ªß, kh√¥ng nh√¢n ƒë√¥i l·ªánh.
* **Gaps**: open gap v∆∞·ª£t SL/TP ‚áí d√πng **Market close** v·ªõi price hi·ªán t·∫°i & **journaling**.
* **Timeout**: ƒë√≥ng to√†n basket khi h·∫øt h·∫°n.
* **Breach**: ch·∫°m **DailyLossLimit** ‚áí **disable entries** ƒë·∫øn h·∫øt ng√†y ICT+7.

---

# 13) Definition of Done (DoD) & Handover Checklist

* [ ] To√†n b·ªô tham s·ªë trong b·∫£ng **c√≥ th·ªÉ set** qua Input/Param.
* [ ] ƒê√£ chu·∫©n ho√° **pip‚Üîpoints**; **MinStop clamp** ho·∫°t ƒë·ªông.
* [ ] **SMC/Momentum** ch·∫°y ƒë·ªôc l·∫≠p ho·∫∑c hybrid; **ConflictPolicy** √°p ƒë√∫ng.
* [ ] **TP/SL** g·∫Øn theo **ph∆∞∆°ng ph√°p Entry**; **Override FixedDistance** ho·∫°t ƒë·ªông khi b·∫≠t.
* [ ] **DCA** theo %Balance + Multiplier; **MaxLotPerSide** (HARD/SOFT) **ƒëang enforce**.
* [ ] **Basket TP/SL** theo %Balance, **Timeout**, **Breach** ho·∫°t ƒë·ªông.
* [ ] **OneTradePerBar**, **RetryOnReject**, **SlippageMax** ho·∫°t ƒë·ªông.
* [ ] **Journal** ƒë·∫ßy ƒë·ªß (signals, prices, lots, slippage, reasons).
* [ ] Backtest pass KPI t·ªëi thi·ªÉu ·ªü **test set**.

---
RULE 
---
Tuy·ªát v·ªùi ‚Äî em b·ªï sung **quy t·∫Øc v√≤ng ƒë·ªùi (lifecycle)** cho t·ª´ng c·∫•u tr√∫c: **FVG, OB, Momentum leg, Sideway BOX**, g·ªìm: **khi h√¨nh th√†nh**, **ƒëang hi·ªáu l·ª±c**, **ho√†n th√†nh/mitigated**, **h·∫øt hi·ªáu l·ª±c/invalid**, **h·∫øt h·∫°n/expired theo th·ªùi gian**, **renew (t·∫°o m·ªõi & d·ªçn c≈©)**; k√®m **quy t·∫Øc v·∫Ω BOX & ghi nh√£n**; **c·ª≠a s·ªï qu√©t (bao nhi√™u c√¢y n·∫øn)**; v√† **c√°ch cho ph√©p nhi·ªÅu c·∫•u tr√∫c ƒë·ªìng th·ªùi & chia nh·ªè nhi·ªÅu l·ªánh**. T·∫•t c·∫£ ƒë·ªÅu ‚Äúcodeable‚Äù.

---

# 1) Decompose ‚Üí Plan ‚Üí ToT (scored) ‚Üí Reverse Thinking

**Decompose**

* **ƒê·ªëi t∆∞·ª£ng & v√≤ng ƒë·ªùi**: FVG, OB, Momentum leg, Sideway BOX (m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ tr·∫°ng th√°i: `NEW ‚Üí ACTIVE ‚Üí (PARTIAL|MITIGATED) ‚Üí (COMPLETED|INVALID|EXPIRED)`).
* **Qu√©t & TTL**: s·ªë **bars** ƒë·ªÉ qu√©t & th·ªùi h·∫°n (**TTL_Bars**) ri√™ng cho t·ª´ng ƒë·ªëi t∆∞·ª£ng (M5 m·∫∑c ƒë·ªãnh, M15 nh√¢n ƒë√¥i).
* **Entry Engine**: cho ph√©p **nhi·ªÅu ƒë·ªëi t∆∞·ª£ng c√πng chi·ªÅu** ph√°t sinh **nhi·ªÅu entry** (split risk) c√≥ gi·ªõi h·∫°n **MaxOrders & MaxLotPerSide**.
* **Charting**: quy t·∫Øc v·∫Ω **BOX** & **label** (m√†u, text, id, status, age, size).

**Plan (chu·ªói x·ª≠ l√Ω)**

1. M·ªói bar m·ªõi: **Qu√©t** c·∫•u tr√∫c (FVG/OB/BOS/Momentum) trong **Lookback_Bars**.
2. **C·∫≠p nh·∫≠t v√≤ng ƒë·ªùi** t·ª´ng ƒë·ªëi t∆∞·ª£ng theo gi√° hi·ªán t·∫°i (fill %, invalid‚Ä¶), ƒë·ªïi tr·∫°ng th√°i & v·∫Ω/·∫©n box.
3. **Sinh t√≠n hi·ªáu entry** t·ª´ ƒë·ªëi t∆∞·ª£ng **ACTIVE** theo rule; qu·∫£n l√Ω **split entries** (nhi·ªÅu ƒë·ªëi t∆∞·ª£ng).
4. **C∆∞·ª°ng ch·∫ø r·ªßi ro**: MaxOrders/MaxLotPerSide/Basket SL.
5. **D·ªçn c≈© & Renew** theo TTL, s·ªë l∆∞·ª£ng t·ªëi ƒëa, BOS m·ªõi.

**ToT (3 ki·ªÉu qu·∫£n tr·ªã ƒë·ªëi t∆∞·ª£ng)**

* **Keep-Few-Smart (Recommended)**: gi·ªØ **K m·ªõi nh·∫•t m·ªói chi·ªÅu** + TTL; d·ªçn c≈© khi **BOS m·ªõi** (Correctness 9 | Risk 5 | Cost 6).
* **Keep-All-with-TTL**: gi·ªØ t·∫•t c·∫£ trong TTL (8 | 6 | 5).
* **One-At-A-Time**: m·ªói chi·ªÅu ch·ªâ 1 ƒë·ªëi t∆∞·ª£ng (7 | 4 | 7) ‚Äî √≠t t√≠n hi·ªáu, b·ªè l·ª° c∆° h·ªôi.

**Reverse Thinking**

* Gi·ªØ qu√° nhi·ªÅu FVG/OB ‚áí **ƒë√® ch·ªìng t√≠n hi·ªáu**, d·ªÖ v∆∞·ª£t `MaxOrders/MaxLotPerSide` ‚áí ƒë·∫∑t **K nh·ªè** (2‚Äì4/c√πng chi·ªÅu) v√† **Priority** (g·∫ßn gi√° > xa; m·ªõi > c≈©; size v·ª´a > qu√° m·ªèng).

---

# 2) Lifecycle chi ti·∫øt theo ph∆∞∆°ng ph√°p

> M·∫∑c ƒë·ªãnh **khung M5** (XAUUSD). V·ªõi **M15**, g·ª£i √Ω nh√¢n ƒë√¥i TTL & Lookback.

## 2.1 FVG (3-candle Fair Value Gap)

### A. Khi **h√¨nh th√†nh (NEW)**

* **Up-FVG** (d∆∞·ªõi ‚Üí tr√™n): t·∫°i index `i` n·∫øu `Low[i] > High[i-2]` v√† `size_pts = (Low[i] - High[i-2])/_Point ‚â• FVG_MinSizePts` (m·∫∑c ƒë·ªãnh **300 points**).
* **Down-FVG** t∆∞∆°ng t·ª±: `High[i] < Low[i-2]`.
* L∆∞u tr·ªØ: `id`, `dir`, `upper/lower`, `size_pts`, `bar_index_created`, `status=NEW`.

### B. Khi **ACTIVE**

* Tr·ªü th√†nh **ACTIVE** ngay sau **NEW** (ho·∫∑c c√≥ option delay X bars).
* **Hi·ªáu l·ª±c entry** khi **fill% ‚â• FVG_Entry_MinPct** (m·∫∑c ƒë·ªãnh **50%**) ho·∫∑c ƒë·∫°t ƒëi·ªÅu ki·ªán ri√™ng (v√≠ d·ª• ‚Äú**SMC Pullback** v√†o FVG‚Äù).

### C. **Mitigation / Completion**

* **Mitigated (PARTIAL)**: `fill% ‚â• FVG_MitigatePct` (m·∫∑c ƒë·ªãnh **50%**) nh∆∞ng **< FVG_CompletionPct** (m·∫∑c ƒë·ªãnh **95%**).
* **Completed (COMPLETED)**: `fill% ‚â• FVG_CompletionPct` **ho·∫∑c** c√≥ **1 n·∫øn Close** **v∆∞·ª£t h·∫≥n bi√™n xa** c·ªßa gap **‚â• FVG_CloseBeyondPts** (m·∫∑c ƒë·ªãnh **50 points**) ‚Üí coi nh∆∞ **rebalance xong**.

### D. **Invalidation**

* N·∫øn **ƒë√≥ng c·ª≠a** **v∆∞·ª£t h·∫≥n** bi√™n xa **+ Buffer** (m·∫∑c ƒë·ªãnh **SLBufferPts=300**) **v√†** **ti·∫øp di·ªÖn th√™m 1 n·∫øn** c√πng ph√≠a (x√°c nh·∫≠n) ‚áí tr·∫°ng th√°i **INVALID** (ph√° c·∫•u tr√∫c).
* *Kh√°c v·ªõi ‚ÄúCompleted‚Äù*: `COMPLETED` = **ƒëi·ªÅn ƒë·ªß** gap; `INVALID` = **b·ªã ph√°** v∆∞·ª£t xa (th∆∞·ªùng b·ªè √Ω nghƒ©a entry pullback).

### E. **H·∫øt h·∫°n theo th·ªùi gian (EXPIRED)**

* Qu√° **FVG_TTL_Bars** (m·∫∑c ƒë·ªãnh **150 bars** tr√™n M5) **m√† ch∆∞a Mitigated/Completed**, auto **EXPIRED** (gi·∫£m nhi·ªÖu).

### F. **Renew**

* Khi xu·∫•t hi·ªán **BOS m·ªõi** c√πng chi·ªÅu ‚Üí **t·∫°o FVG m·ªõi**; √°p `ZoneKeepPolicy`:

  * **K_FVG_KeepPerSide = 3** (m·∫∑c ƒë·ªãnh): ch·ªâ gi·ªØ 3 FVG m·ªõi nh·∫•t c√πng chi·ªÅu, c≈© h∆°n ‚Üí **ARCHIVED** (·∫©n & kh√¥ng trade).
  * N·∫øu **FVG m·ªõi** ‚Äúbao tr√πm‚Äù > **X%** FVG c≈© (m·∫∑c ƒë·ªãnh **80%**) ‚Üí g·ªôp & **deprecate** FVG c≈©.

### G. **Qu√©t bao nhi√™u c√¢y n·∫øn** - DYNAMIC SCAN

* **FVG qu√©t ƒë·ªông**: Gi√° t·ªõi ƒë√¢u qu√©t t·ªõi ƒë√≥, **KH√îNG** gi·ªõi h·∫°n Lookback c·ª©ng.
* **Lo·∫°i b·ªè FVG ƒë√£ ho√†n th√†nh** (COMPLETED/INVALID/EXPIRED) kh·ªèi danh s√°ch Active.
* **Max concurrent**: `K_FVG_KeepPerSide = 3` (gi·ªØ t·ªëi ƒëa 3 FVG Active m·ªói chi·ªÅu). **CONFIRMED**.

### H. **Nhi·ªÅu FVG & nhi·ªÅu l·ªánh**

* Cho ph√©p entry **t·ªëi ƒëa N_FVG_ActiveEntries = 2** m·ªói chi·ªÅu; ∆∞u ti√™n **FVG g·∫ßn gi√°** & **size v·ª´a**;
* **Split risk**: m·ªói FVG ti√™u th·ª• **‚â§ 1/N_FVG_ActiveEntries** c·ªßa `MaxOrders` c√≤n l·∫°i; v·∫´n **enforce MaxLotPerSide**.

---

## 2.2 OB (Order Block)

### A. Khi **h√¨nh th√†nh (NEW)**

* Sau khi c√≥ **BOS** (close v∆∞·ª£t swing), **OB** l√† **n·∫øn ng∆∞·ª£c chi·ªÅu cu·ªëi** tr∆∞·ªõc impulse t·∫°o BOS.
* V√πng OB = [**High, Low**] c·ªßa n·∫øn ƒë√≥ (tu·ª≥ Buy/Sell); c√≥ th·ªÉ **RefineBody** = [Open, Close] (config).

### B. Khi **ACTIVE**

* Hi·ªáu l·ª±c cho **pullback**: entry h·ª£p l·ªá khi gi√° **ƒëi v√†o OB ‚â• OB_Pullback_MinPct** (m·∫∑c ƒë·ªãnh **25%** ƒë·ªô d√†y OB).

### C. **Mitigated / Multi-touch**

* **Mitigated (PARTIAL)**: khi **touch ‚â• OB_MitigatePct** (m·∫∑c ƒë·ªãnh **33%**).
* Cho ph√©p **MaxTouches** (m·∫∑c ƒë·ªãnh **2**): sau **touch #MaxTouches**, chuy·ªÉn **COMPLETED** (coi nh∆∞ d√πng xong), tr·ª´ khi c√≥ **rejection m·∫°nh** (Close ƒë·∫£o chi·ªÅu t·∫°o **HL/LH m·ªõi**), khi ƒë√≥ ph√©p **1 l·∫ßn extra** (config).

### D. **Invalidation**

* **Close v∆∞·ª£t bi√™n ƒë·ªëi di·ªán OB + Buffer (SLBufferPts)** ‚áí **INVALID** (v√πng m·∫•t √Ω nghƒ©a cung/c·∫ßu).
* Ho·∫∑c **CHOCH** ng∆∞·ª£c chi·ªÅu (Close ph√° swing ng∆∞·ª£c) ngay **b√™n trong** v√πng ‚áí **INVALID**.

### E. **H·∫øt h·∫°n (EXPIRED)**

* **OB_TTL_Bars = 200** (M5). Qu√° TTL m√† **ch∆∞a pullback** ‚áí **EXPIRED**.

### F. **Renew**

* **BOS m·ªõi** c√πng chi·ªÅu ‚áí t·∫°o **OB m·ªõi**; √°p **K_OB_KeepPerSide=2**. OB c≈© **xa gi√°** h∆°n **MaxDistanceFromPricePts** (m·∫∑c ƒë·ªãnh **8000 points**) auto **ARCHIVED**.

---

## 2.3 Momentum leg (Breakout/Displacement)

### A. Khi **h√¨nh th√†nh (NEW)**

* **BarBreakout** ƒë√≥ng **tr√™n SwingH** (Buy) / **d∆∞·ªõi SwingL** (Sell) **v√†** `TrueRange ‚â• ATR(14) * MinDispATR_Momo` (m·∫∑c ƒë·ªãnh **1.2**).
* Ghi nh·∫≠n **pre-breakout range** = [Swing, Close tr∆∞·ªõc], **bar_range_pts**, **dir**, **status=NEW**.

### B. Khi **ACTIVE**

* Entry ki·ªÉu **Momentum**: v√†o **ngay close** bar ph√° (market) ho·∫∑c **Stop** t·∫°i bi√™n Swing ¬± buffer.
* V·ªõi **SMC**: c√≥ th·ªÉ ch·ªù **pullback** v·ªÅ OB/FVG sinh ra **b·ªüi ch√≠nh leg n√†y**.

### C. **K·∫øt th√∫c ‚Äúleg‚Äù (COMPLETED)**

* B·∫•t k·ª≥ ƒëi·ªÅu ki·ªán n√†o sau ƒë√¢y (ch·ªçn 1 trong 3 ‚Üí **COMPLETED**):

  1. **TP1 (1R)** ƒë·∫°t v√† **ATR-trail** ƒë√£ k√≠ch ho·∫°t ‚â• X bars (m·∫∑c ƒë·ªãnh **3 bars**).
  2. **Pullback test** v·ªÅ **mid c·ªßa breakout bar** v√† **reject** t·∫°o **HL/LH m·ªõi** c√πng chi·ªÅu.
  3. **Time-based**: qu√° **MOMO_TTL_Bars = 20** (M5).

### D. **H·∫øt t√°c d·ª•ng (INVALID)**

* **False Break**: trong **MOMO_Fail_Bars = 5**, c√≥ **Close** **tr·ªü l·∫°i** **b√™n trong 50% pre-breakout range** **2 l·∫ßn li√™n ti·∫øp**.
* **CHOCH ng∆∞·ª£c chi·ªÅu**: Close ph√° **swing ƒë·ªëi di·ªán** k·ªÉ t·ª´ khi leg b·∫Øt ƒë·∫ßu.
* **Close xuy√™n ‚Äúƒë√°y/ƒë·ªânh‚Äù breakout bar** **+ Buffer** trong **2 bars** li√™n ti·∫øp.

### E. **Renew**

* N·∫øu xu·∫•t hi·ªán **breakout m·ªõi** c√πng chi·ªÅu c√≥ `TR/ATR` **l·ªõn h∆°n** leg hi·ªán t·∫°i ‚â• **1.1√ó**, mark leg c≈© **COMPLETED** v√† rebase sang leg m·ªõi (ƒë·∫£m b·∫£o ‚Äúƒë·ªông l·ª±c‚Äù t∆∞∆°i).

---

## 2.4 Sideway BOX (ƒë·ªÉ ‚Äúk·∫øt th√∫c FVG‚Äù & qu·∫£n tr·ªã v√πng)

### A. Khi **h√¨nh th√†nh (NEW)**

* **BOX** ph√°t hi·ªán khi trong **S_Window = 20 bars** (M5) c√≥ **bi√™n ƒë·ªô** `MaxHigh - MinLow ‚â§ Box_MaxWidthPts` (m·∫∑c ƒë·ªãnh **4000 points**) **v√†** **kh√¥ng** c√≥ n·∫øn `TrueRange ‚â• ATR(14)*Box_BreakoutATR` (m·∫∑c ƒë·ªãnh **1.2**).
* M√©p BOX = `MaxHigh` & `MinLow` trong c·ª≠a s·ªï.

### B. Khi **ACTIVE**

* V·∫Ω **BOX** ƒë·ªÉ *‚Äúneo‚Äù* c√°c **FVG/OB** ph√≠a trong. N·∫øu **FVG ƒë∆∞·ª£c Completed** b√™n trong BOX, c√≥ th·ªÉ **ƒë√°nh d·∫•u sub-box** ‚ÄúFVG done‚Äù.

### C. **K·∫øt th√∫c (COMPLETED)**

* Khi c√≥ **n·∫øn ƒë√≥ng c·ª≠a** **v∆∞·ª£t m√©p BOX + Box_BufferPts** (m·∫∑c ƒë·ªãnh **150 points**) **v√†** `TrueRange ‚â• ATR*Box_BreakoutATR` ‚áí **BOX COMPLETED** (breakout).
* **FVG end hook**: n·∫øu BOX ch·ª©a FVG v√† FVG ƒë·∫°t **Completed**, v·∫Ω **mini-box END** (ƒëo·∫°n fill cu·ªëi).

### D. **Invalid**

* **3 l·∫ßn false break** (ƒë√≥ng ra‚Äìv√†o li√™n ti·∫øp 3 l·∫ßn) trong **Box_FalseBreakBars = 10** ‚áí BOX **INVALID** (nhi·ªÖu), s·∫Ω **renew** n·∫øu ƒëi·ªÅu ki·ªán l·∫°i th·ªèa.

### E. **Renew**

* Khi BOX k·∫øt th√∫c/invalid, b·∫Øt ƒë·∫ßu ƒë·∫øm l·∫°i c·ª≠a s·ªï; c√≥ th·ªÉ **n·ªëi** th√†nh **BOX m·ªõi** n·∫øu gi√° quay l·∫°i dao ƒë·ªông h·∫πp.

---

# 3) Quy t·∫Øc **v·∫Ω BOX & nh√£n (text)**

## 3.1 ƒê·ªëi t∆∞·ª£ng & m√†u (suggest)

* **FVG**: Rectangle m·ªù. `ACTIVE` xanh l√° (up) / ƒë·ªè (down); `PARTIAL` v√†ng; `COMPLETED` x√°m; `INVALID` ƒëen g·∫°ch ch√©o; `EXPIRED` ·∫©n.
* **OB**: Rectangle vi·ªÅn d√†y; m√†u gi·ªëng FVG theo chi·ªÅu; `Mitigated` ch·∫•m bi; `Invalid` g·∫°ch ch√©o.
* **Momentum leg**: Arrow/line theo h∆∞·ªõng; `COMPLETED` m·∫£nh; `INVALID` ƒë·ª©t n√©t.
* **Sideway BOX**: Rectangle xanh d∆∞∆°ng nh·∫°t; `COMPLETED` ƒë·ªïi sang t√≠m trong 3 bars, r·ªìi ·∫©n.

## 3.2 N·ªôi dung label (m·ªói BOX/zone)

```
<ID>#<dir> <type> <status>
age=<bars> size=<pts> fill=<%> touches=<n> TTL=<remain>
entry=<rule> stop=<rule> tp=<rule>   // n·∫øu ƒë·ªëi t∆∞·ª£ng sinh entry
```

* **ID** tƒÉng d·∫ßn; **dir**: UP/DN; **type**: FVG/OB/BOX/MOMO; **status** nh∆∞ lifecycle.

## 3.3 Quy t·∫Øc v·∫Ω/·∫©n

* V·∫Ω **khi NEW/ACTIVE/PARTIAL**;
* **COMPLETED**: gi·ªØ l·∫°i **Label** trong **KeepLabels_Bars=10** r·ªìi ·∫©n;
* **INVALID/EXPIRED**: ·∫©n ngay ho·∫∑c m·ªù 30%.

---

# 4) Nhi·ªÅu m√¥ h√¨nh ƒë·ªìng th·ªùi & chia nhi·ªÅu l·ªánh (split entries)

**Policy (khuy·∫øn ngh·ªã)**

* **Max concurrent objects per side**:

  * `K_FVG_KeepPerSide=3`, `K_OB_KeepPerSide=2`, `K_MOMO_Keep=1`, `K_BOX_Keep=1`.
* **Entry budget**: t·ªïng s·ªë l·ªánh m·ªõi (ch∆∞a t√≠nh DCA) **‚â§ NewEntryBudget = min(2, MaxOrders - CurrentOrders)**.
* **∆Øu ti√™n**: (1) **FVG g·∫ßn gi√°** & **size v·ª´a** (300‚Äì1200 pts) ‚Üí (2) **OB g·∫ßn gi√°** ‚Üí (3) **Momentum stop**.
* **Split risk**: chia ƒë·ªÅu **BaseRiskPct_PerAdd** cho s·ªë ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c ch·ªçn trong `NewEntryBudget`.
* **T√¥n tr·ªçng**: `MaxLotPerSide`, `CapMode`, `MinDistFromAvg`.

---

# 5) Tham s·ªë m·ªõi (b·ªï sung cho lifecycle)

| Nh√≥m  | Tham s·ªë            | Default |   Min/Max | [Why]                            |
| ----- | ------------------ | ------: | --------: | -------------------------------- |
| FVG   | FVG_MinSizePts     |     300 |   150‚Äì600 | Gap ƒë·ªß √Ω nghƒ©a.                  |
| FVG   | FVG_Entry_MinPct   |     50% |    25‚Äì80% | Pullback ƒë·ªß s√¢u.                 |
| FVG   | FVG_MitigatePct    |     50% |    33‚Äì80% | G·∫Øn tr·∫°ng th√°i PARTIAL.          |
| FVG   | FVG_CompletionPct  |     95% |   80‚Äì100% | Ho√†n t·∫•t rebalance.              |
| FVG   | FVG_CloseBeyondPts |      50 |    20‚Äì100 | Close v∆∞·ª£t bi√™n xa coi nh∆∞ xong. |
| FVG   | FVG_TTL_Bars       |     150 |    60‚Äì300 | H·∫øt h·∫°n theo th·ªùi gian.          |
| FVG   | FVG_Lookback_Bars  |     600 |  300‚Äì1200 | C·ª≠a s·ªï qu√©t.                     |
| FVG   | K_FVG_KeepPerSide  |       3 |       1‚Äì5 | Gi·ªõi h·∫°n s·ªë FVG ho·∫°t ƒë·ªông.       |
| OB    | OB_Pullback_MinPct |     25% |    10‚Äì60% | ƒêi·ªÅu ki·ªán entry.                 |
| OB    | OB_MitigatePct     |     33% |    25‚Äì60% | ƒê√°nh d·∫•u PARTIAL.                |
| OB    | OB_TTL_Bars        |     200 |    80‚Äì400 | H·∫øt h·∫°n theo th·ªùi gian.          |
| OB    | MaxTouches         |       2 |       1‚Äì3 | S·ªë l·∫ßn ‚Äúd√πng‚Äù v√πng.              |
| MOMO  | MinDispATR_Momo    |     1.2 |   1.0‚Äì2.5 | Ch·ªëng false break.               |
| MOMO  | MOMO_Fail_Bars     |       5 |       2‚Äì8 | Ki·ªÉm ƒë·ªãnh th·∫•t b·∫°i s·ªõm.          |
| MOMO  | MOMO_TTL_Bars      |      20 |     10‚Äì40 | Leg qu√° c≈© th√¨ xong.             |
| BOX   | S_Window           |      20 |     10‚Äì40 | C·ª≠a s·ªï sideway.                  |
| BOX   | Box_MaxWidthPts    |    4000 | 2000‚Äì8000 | ƒê·ªô h·∫πp sideway.                  |
| BOX   | Box_BreakoutATR    |     1.2 |   1.0‚Äì2.0 | X√°c nh·∫≠n breakout.               |
| BOX   | Box_BufferPts      |     150 |    50‚Äì300 | Tr√°nh false break.               |
| BOX   | Box_FalseBreakBars |      10 |      5‚Äì20 | Nhi·ªÖu ‚Üí invalid.                 |
| Chart | KeepLabels_Bars    |      10 |      0‚Äì50 | Gi·ªØ d·∫•u v·∫øt.                     |

---

# 6) Pseudocode (qu·∫£n tr·ªã lifecycle & entry ƒëa ƒë·ªëi t∆∞·ª£ng)

```pseudocode
OnNewBar():
  UpdateATR()
  DetectSwings(fractal_k)
  new_fvg = DetectFVG(FVG_Lookback_Bars, FVG_MinSizePts)
  new_ob  = DetectOB_OnBOS()
  new_momo = DetectMomentumBreakout(MinDispATR_Momo)

  RegisterObjects(new_fvg, new_ob, new_momo)  // push to store with id, dir, status=NEW

  For each obj in Store:
    UpdateLifecycle(obj)   // -> ACTIVE/PART
```
D∆∞·ªõi ƒë√¢y l√† b·∫£n ‚Äúwrite-up‚Äù k·ªπ thu·∫≠t ho√° to√†n b·ªô TP/SL/Entry cho ICT‚ÄìSMC‚ÄìMomentum, b·ªï sung ch√≠nh x√°c theo t√†i li·ªáu b·∫°n ƒë∆∞a, ƒë·∫∑c bi·ªát tr·∫£ l·ªùi c√°c ƒëi·ªÉm b·∫°n y√™u c·∫ßu: khi n√†o m√¥ h√¨nh h√¨nh th√†nh, khi n√†o h·∫øt t√°c d·ª•ng/ho√†n th√†nh, khi n√†o ‚Äúrenew‚Äù, v·∫Ω BOX & g√°n nh√£n, qu√©t bao nhi√™u n·∫øn, c√≥ th·ªÉ c√≥ nhi·ªÅu FVG v√† chia nhi·ªÅu l·ªánh.

---

# 1) Decompose ‚Üí Plan ‚Üí ToT (scored) ‚Üí Reverse Thinking

**Decompose (7 kh·ªëi):**

1. Entry Logic (ICT/SMC): Sweep ‚Üí Displacement (MSS/BOS) ‚Üí POI (FVG/OB) ‚Üí Premium/Discount.   
2. Market Filters: Spread guard, Session/Kill Zone, Premium/Discount.  
3. Momentum Module: Displacement = n·∫øn c√≥ range > ATR*N; exit ki·ªÉu Chandelier/ATR trail.  
4. POI Lifecycle: FVG/OB formation ‚Üí active ‚Üí mitigated/invalidated ‚Üí renew & archive.  
5. Order Sizing & DCA: nhi·ªÅu POI, chia l·ªánh, MaxLotPerSide.
6. Risk/Exit: SL chu·∫©n c·∫•u tr√∫c (ƒë√°y/ƒë·ªânh sweep), TP m·ª•c ti√™u ‚Äúƒëi·ªÉm y·∫øu‚Äù ho·∫∑c thanh kho·∫£n (BSL/SSL), RR c·ªë ƒë·ªãnh optional; momentum d√πng ATR trail/ƒë·∫£o t√≠n hi·ªáu.   
7. Visualization & State Machine: BOX + text, TTL & scan windows, states t·ª´ Scan‚ÜíSignal‚ÜíPending‚ÜíActive‚ÜíExit.

**Plan (chu·ªói x·ª≠ l√Ω m·ªói bar):**
(1) C·∫≠p nh·∫≠t swing, BOS/MSS, displacement (ATR), Premium/Discount ‚Üí (2) Ph√°t hi·ªán POI m·ªõi (FVG/OB), ƒëƒÉng k√Ω BOX & TTL ‚Üí (3) B·ªô l·ªçc session/spread ‚Üí (4) L·∫≠p danh s√°ch Entry candidates (prioritize) ‚Üí (5) ƒê·∫∑t limit/market theo rule ‚Üí (6) Qu·∫£n tr·ªã v·ªã th·∫ø (SL/TP/Trail/Partial) ‚Üí (7) ƒê·ªïi tr·∫°ng th√°i POI (mitigated/invalidated/expired), v·∫Ω ‚ÄúEnd Box‚Äù.

**ToT ‚Äì 3 ph∆∞∆°ng √°n qu·∫£n tr·ªã FVG lifecycle (ƒëi·ªÉm ch√≠nh b·∫°n h·ªèi):**

* **A) TTL theo th·ªùi gian (bars)**: FVG/OB h·∫øt hi·ªáu l·ª±c sau `ttl_bars` n·∫øu ch∆∞a ƒë∆∞·ª£c ‚Äútouch/mitigate‚Äù.

  * *Score*: Correctness 7/10, Risk 6/10, Cost/Time 3/10 (d·ªÖ code).
* **B) TTL theo c·∫•u tr√∫c**: POI s·ªëng ƒë·∫øn khi c√≥ BOS ng∆∞·ª£c + displacement ph√° v·ª° ph·∫°m vi t·∫°o ra POI.

  * *Score*: Correctness 9/10, Risk 5/10, Cost/Time 6/10 (logic ch·∫∑t, code ph·ª©c t·∫°p h∆°n).
* **C) TTL lai (time + structure) + kh·ªëi l∆∞·ª£ng (n·∫øu c√≥)**: h·∫øt h·∫°n n·∫øu qu√° `ttl_bars` **ho·∫∑c** xu·∫•t hi·ªán BOS ng∆∞·ª£c c√≥ displacement **ho·∫∑c** ATR regime chuy·ªÉn th·∫•p k√©o d√†i.

  * *Score*: Correctness 9/10, Risk 4/10, Cost/Time 7/10.
    **Khuy·∫øn ngh·ªã:** C (lai), v√¨ b√°m s√°t ‚Äúdisplacement/structure‚Äù v√† tr√°nh gi·ªØ POI c≈© k·ªπ.

**Reverse Thinking (contrarian):**

* N·∫øu ‚Äúdisplacement‚Äù ch·ªâ l√† n·∫øn l·ªõn v√¨ news/spread spike? ‚Üí B·∫Øt bu·ªôc x√°c nh·∫≠n FVG xu·∫•t hi·ªán ƒë·ªìng th·ªùi v√† spread guard + news embargo. 
* N·∫øu FVG b·ªã ‚Äúl·∫•p‚Äù b·∫±ng **wick** m·ªèng ‚Üí Cho ph√©p tr·∫°ng th√°i ‚Äúpartially mitigated‚Äù v√† v·∫´n c√≤n hi·ªáu l·ª±c n·∫øu ch∆∞a 100% filled.
* N·∫øu nhi·ªÅu FVG x·∫øp t·∫ßng g√¢y overtrading ‚Üí H·∫°n ch·∫ø `max_pending_pois`, ∆∞u ti√™n theo ‚Äúƒë·ªô t∆∞∆°i‚Äù + ‚Äúk√≠ch th∆∞·ªõc FVG/ATR‚Äù + Premium/Discount. 

---

# 2) Questions c·∫ßn ƒë·ªÉ ch·ªët (targeted)

1. **Symbol/TF & Broker**: v·∫´n XAUUSD M5? digits 3/5? min lot step? stopLevel? (ƒë·ªÉ t√≠nh SL/TP theo points ch√≠nh x√°c).
2. **Session TZ**: gi·ªØ Asia/Ho_Chi_Minh ‚Üí quy ƒë·ªïi Kill Zone sang broker time hay UTC? 
3. **News filter**: c√≥ b·∫≠t/ngu·ªìn n√†o?
4. **MaxLotPerSide**: gi√° tr·ªã m·∫∑c ƒë·ªãnh & tƒÉng theo DCA hay c·ª©ng t·ªïng?
5. **TP/SL override**: Khi b·∫≠t ‚ÄúTP/SL theo pip‚Äù, c√≥ **ghi ƒë√®** to√†n b·ªô rule c·∫•u tr√∫c (ICT/SMC) hay ch·ªâ l√† ‚ÄúTP2‚Äù song song?
6. **Kh·ªëi l∆∞·ª£ng**: Chia l·ªánh theo bao nhi√™u POI t·ªëi ƒëa c√πng l√∫c (`max_pois_active`), v√† c√≥ cho ph√©p stacking tr√™n 1 POI (edge/mid/50%)?

---

# 3) SPEC chi ti·∫øt (SRS/PRD + Pseudocode)

## 3.1. Glossary (ƒë·ªãnh nghƒ©a c√≥ th·ªÉ code)

* **Swing High/Low**: n·∫øn c√≥ high cao h∆°n/lower th·∫•p h∆°n N n·∫øn hai b√™n (`swing_lookback_period`, m·∫∑c ƒë·ªãnh 2). 
* **Displacement**: n·∫øn C c√≥ **range** > ATR(N)*M; khuy·∫øn ngh·ªã N=14, M=2.0. 
* **Liquidity Sweep**: price qu√©t qua m·ª©c thanh kho·∫£n b·∫±ng wick nh∆∞ng **ƒë√≥ng** tr·ªü l·∫°i b√™n trong. ƒêi·ªÅu ki·ªán: `low<L && close>L` (v·ªõi ƒë√°y), ng∆∞·ª£c l·∫°i cho ƒë·ªânh. 
* **FVG (3 n·∫øn)**: Bullish: `c3.low > c1.high`; Bearish: `c3.high < c1.low`; n·∫øn 2 l√Ω t∆∞·ªüng l√† displacement. 
* **Order Block (OB)**: n·∫øn ng∆∞·ª£c xu h∆∞·ªõng cu·ªëi c√πng **tr∆∞·ªõc** displacement g√¢y BOS/CHoCH; ∆∞u ti√™n OB ƒë√£ qu√©t thanh kho·∫£n v√† t·∫°o FVG.  
* **Premium/Discount**: ph·∫°m vi chia b·ªüi 50% fib: tr√™n = Premium (b√°n), d∆∞·ªõi = Discount (mua). 
* **ƒêi·ªÉm M·∫°nh/Y·∫øu**: swing t·∫°o BOS ‚áí ‚Äúm·∫°nh‚Äù; swing kh√¥ng t·∫°o high/low ti·∫øp theo ‚áí ‚Äúy·∫øu‚Äù (m·ª•c ti√™u TP). 
* **Kill Zones**: London Open, NY Open‚Ä¶ thu·∫≠t to√°n ch·ªâ ho·∫°t ƒë·ªông trong c√°c c·ª≠a s·ªï n√†y. 

## 3.2. Lifecycle & BOX (h√¨nh th√†nh/k·∫øt th√∫c/renew)

### FVG Lifecycle

* **Formation**: khi ph√°t hi·ªán pattern 3 n·∫øn th·ªèa ƒëi·ªÅu ki·ªán; l∆∞u `fvg_id`, `type`, bi√™n `upper/lower`, `formed_bar_index`, `atr_at_birth`. 
* **Active (Valid)** n·∫øu:

  * K√≠ch th∆∞·ªõc ‚â• `fvg_min_size_atr_mult * ATR` t·∫°i th·ªùi ƒëi·ªÉm h√¨nh th√†nh. (m·∫∑c ƒë·ªãnh 0.5). 
  * Thu·ªôc v√πng ƒë√∫ng (Bullish FVG n·∫±m trong Discount; Bearish trong Premium) ‚Äì optional filter. 
* **Completed (Mitigated 100%)**: khi **gi√° ch·∫°m & ƒëi xuy√™n to√†n b·ªô v√πng** (close ho·∫∑c wick ch·∫°m c·∫°nh ƒë·ªëi di·ªán) ‚Üí ƒë·ªïi tr·∫°ng th√°i `mitigated=true`, v·∫Ω BOX ‚ÄúFVG Mitigated ‚Äì #id ‚Äì time‚Äù.
* **Partially Mitigated**: gi√° ‚Äútouch‚Äù nh∆∞ng ch∆∞a l·∫•p 100% ‚Üí v·∫´n **Valid** cho ƒë·∫øn khi ƒë·ªß 100% ho·∫∑c h·∫øt TTL.
* **Invalidated** (h·∫øt t√°c d·ª•ng):

  * BOS ng∆∞·ª£c chi·ªÅu **c√≥ displacement** ph√° v·ª° **ƒë√°y/ƒë·ªânh** t·∫°o ra FVG. (structure-based TTL). 
  * Ho·∫∑c qu√° `ttl_bars` k·ªÉ t·ª´ `formed_bar_index` m√† ch∆∞a ƒë∆∞·ª£c test (time-based TTL).
  * Ho·∫∑c ATR regime t·ª•t < ng∆∞·ª°ng (`atr_regime_min`) qu√° `regime_ttl_bars`.
* **Renew**: b·∫•t c·ª© khi n√†o xu·∫•t hi·ªán displacement m·ªõi t·∫°o FVG m·ªõi ‚áí t·∫°o **BOX m·ªõi**; **kh√¥ng** g·ªôp FVG c≈©‚Äìm·ªõi, nh∆∞ng c√≥ th·ªÉ **stack** theo th·ª© t·ª± ∆∞u ti√™n (xem 3.4).

**V·∫Ω BOX & Text (FVG):**

* Rect m√†u theo type; Label: `FVG-[B|S] #[id] size=XX pts ATR=YY formed=t` + `state=[Active|Partial|Mitigated|Invalid]` + `TTL=[x/y]`.
* Khi ‚ÄúCompleted/Invalidated‚Äù ‚Üí v·∫Ω **End Box** m·ªù (d·∫•u hi·ªáu k·∫øt th√∫c) + note ‚Äúreason=[Mitigated/BOS-Inv/Time-Exp]‚Äù.

### OB Lifecycle

* **Formation**: n·∫øn ng∆∞·ª£c xu h∆∞·ªõng cu·ªëi c√πng tr∆∞·ªõc displacement g√¢y BOS/CHoCH; l∆∞u v√πng [low,high]. 
* **Active** n·∫øu: ƒëƒÉng k√Ω ƒë√∫ng h∆∞·ªõng + (tu·ª≥ ch·ªçn) **ƒë√£ qu√©t thanh kho·∫£n tr∆∞·ªõc ƒë√≥** + c√≥ FVG c√πng pha. 
* **Mitigated**: gi√° quay v·ªÅ **ch·∫°m** OB (edge ho·∫∑c 50%) v√† r·ªùi ƒëi; n·∫øu l·∫•p >50% v·∫´n consider ‚Äúlive‚Äù cho l·ªánh limit t·∫°i edge c√≤n l·∫°i (tu·ª≥ ch·ªçn).
* **Invalidated**: gi√° **ƒë√≥ng** v∆∞·ª£t h·∫≥n qua v√πng OB + BOS ng∆∞·ª£c chi·ªÅu c√≥ displacement; ho·∫∑c qu√° `ttl_bars`.
* **Renew**: khi c√≥ displacement m·ªõi k√®m BOS ‚Üí t·∫°o OB m·ªõi, ∆∞u ti√™n OB ‚Äúth·ª© 2‚Äù theo khuy·∫øn ngh·ªã SMC. 

**V·∫Ω BOX & Text (OB):**

* Label: `OB-[B|S] #[id] width=XX pts FVGlink=[id?] swept=[Y/N] state=...`.

### Liquidity (BSL/SSL, EQH/EQL, PDH/PDL, PWH/PWL)

* L·∫≠p b·∫£n ƒë·ªì c√°c m·ª©c thanh kho·∫£n: PDH/PDL, PWH/PWL, ƒê·ªânh/ƒê√°y phi√™n √Å, EQL/EQH (c√≥ `tolerance`). 
* ‚ÄúQu√©t thanh kho·∫£n‚Äù ƒë·ªãnh nghƒ©a nh∆∞ tr√™n; d√πng ƒë·ªÉ **k√≠ch ho·∫°t** m√¥ h√¨nh ƒë·∫£o chi·ªÅu. 

## 3.3. Entry Rules (ICT/SMC core)

**Chu·ªói chu·∫©n (Long):**

1. **Sweep ƒë√°y** (SSL taken) theo ƒë·ªãnh nghƒ©a wick/close. 
2. **MSS/BOS tƒÉng** v·ªõi **displacement** (n·∫øn > ATR*M). 
3. **POI**: ch·ªçn **FVG/OB** h√¨nh th√†nh trong displacement ·ªü (2), **n·∫±m trong Discount**.  
4. **Kill Zone/Session** h·ª£p l·ªá ‚Üí ƒë·∫∑t **limit** t·∫°i m√©p g·∫ßn nh·∫•t c·ªßa POI. 
5. **SL** = **d∆∞·ªõi ƒë√°y** c·ªßa c√∫ sweep (ƒëi·ªÉm v√¥ hi·ªáu c·∫•u tr√∫c). **TP** = **ƒë·ªânh y·∫øu/BSL** k·∫ø ti·∫øp ho·∫∑c th√™m RR c·ªë ƒë·ªãnh (2R‚Äì3R).  

**Chu·ªói Short**: ƒë·ªëi x·ª©ng (sweep ƒë·ªânh ‚Üí MSS gi·∫£m ‚Üí Bearish POI ·ªü Premium ‚Üí limit t·∫°i c·∫°nh g·∫ßn ‚Üí SL tr√™n ƒë·ªânh sweep ‚Üí TP v·ªÅ ƒë√°y y·∫øu/SSL).

## 3.4. ∆Øu ti√™n & nhi·ªÅu POI (nhi·ªÅu FVG/OB, chia l·ªánh)

* `poi_priority` (gi·∫£m d·∫ßn):

  1. **Tu·ªïi tr·∫ª** (m·ªõi h√¨nh th√†nh)
  2. **K√≠ch th∆∞·ªõc** FVG l·ªõn theo ATR (‚â• `fvg_min_size_atr_mult`) 
  3. **Confluence**: POI trong ƒë√∫ng Premium/Discount, c√≥ **sweep tr∆∞·ªõc ƒë√≥**, c√≥ **FVG+OB** chung pha.  
* `max_pending_pois_per_side` (v√≠ d·ª• 3) + `max_positions_per_side`.
* **Chia l·ªánh** tr√™n **1 POI**: `EntryDistributionMode = EDGE_ONLY | EDGE+MID | EDGE+MID+50%` (t·ªâ l·ªá 50/30/20).
* **Chia l·ªánh** tr√™n **nhi·ªÅu POI**: d√†n theo priority cho t·ªõi khi ch·∫°m `MaxLotPerSide`.

## 3.5. Momentum Systems (t√°ch module)

* **MA Crossover**: v√†o khi ƒë√≥ng n·∫øn giao c·∫Øt; **Exit** b·∫±ng **ATR trailing (Chandelier)** ho·∫∑c **ƒë·∫£o t√≠n hi·ªáu**; TP c·ªë ƒë·ªãnh l√† optional.  
* **Breakout + Volume** (n·∫øu c√≥ volume): x√°c nh·∫≠n ph√° v·ª° k√®m spike volume. 

**Khi momentum ‚Äúh·∫øt‚Äù:**

* ATR gi·∫£m d∆∞·ªõi `atr_exhaustion_mult * ATR_baseline` nhi·ªÅu bar li√™n ti·∫øp **ho·∫∑c** xu·∫•t hi·ªán giao c·∫Øt ƒë·∫£o chi·ªÅu (MA) ‚Üí ƒë√≥ng l·ªánh. 

## 3.6. TP/SL (chu·∫©n & override)

* **ICT/SMC chu·∫©n**:

  * **SL**: ƒë√°y/ƒë·ªânh c·ªßa **sweep** (ƒëi·ªÉm invalid). 
  * **TP1**: **ƒëi·ªÉm y·∫øu** g·∫ßn nh·∫•t (EQH/EQL, swing y·∫øu), TP2: BSL/SSL ti·∫øp theo **ho·∫∑c** 2R‚Äì3R. 
  * **Trailing** (tu·ª≥ ch·ªçn): Chandelier ATR. 
* **Momentum**: **kh√¥ng** ƒë·∫∑t TP c·ªë ƒë·ªãnh m·∫∑c ƒë·ªãnh, ch·∫°y theo **ATR trail** ho·∫∑c **ƒë·∫£o t√≠n hi·ªáu**. 
* **Override ‚ÄúTP/SL theo pip‚Äù** (y√™u c·∫ßu b·∫°n):

  * `use_fixed_pips_sl_tp=true` ‚Üí SL/TP = `sl_pips`/`tp_pips` t√≠nh **POINTS** (chu·∫©n ho√° theo symbol digits).
  * Khi b·∫≠t override: h·ªá **SMC** v·∫´n v·∫Ω/ƒë√°nh d·∫•u m·ª•c ti√™u c·∫•u tr√∫c nh∆∞ng **kh√¥ng √©p** d√πng l√†m TP/SL.

## 3.7. Market Filters

* **Premium/Discount** ph·∫£i kh·ªõp h∆∞·ªõng (on by default). 
* **Kill Zone/Session** (London/NY) ch·ªâ k√≠ch ho·∫°t trong c·ª≠a s·ªï gi·ªù. 
* **Spread guard**: `max_spread_points` (vd XAUUSD M5 ~350 points m·∫∑c ƒë·ªãnh domain).
* **News embargo**: t·∫Øt ƒë·∫∑t l·ªánh X ph√∫t quanh tin (n·∫øu b·∫°n b·∫≠t).

## 3.8. Order/Risk Manager

* **MaxLotPerSide**: tr·∫ßn t·ªïng **kh·ªëi l∆∞·ª£ng m·ªü + pending** m·ªói chi·ªÅu.
* **Position limits**: `max_positions_per_side`, `max_pending_pois_per_side`.
* **One-trade-per-bar** (optional), **retry on requote**.
* **R·ªßi ro** theo %balance (Elliott doc khuy√™n 1‚Äì3%/trade, RR ‚â• 3:1 ‚Äì tham kh·∫£o ƒë·ªÉ set default). 

## 3.9. Visualization (v·∫Ω BOX & Text)

* **FVG Box**: m√†u theo direction; vi·ªÅn n√©t ƒë·ª©t n·∫øu Partial. Text: `FVG-B#[id] size=.. ATR=.. state=.. TTL k/n`.
* **OB Box**: m√†u kh√°c; Text: `OB-B#[id] swept=Y/N hasFVG=Y/N state=..`.
* **Liquidity Lines**: PDH/PDL, PWH/PWL, EQH/EQL (ghi `tol=X pts`). 
* **End Box** (khi ho√†n th√†nh/invalid): h·ªôp m·ªù + ghi reason.

## 3.10. State Machine (text)

* **SCAN**: c·∫≠p nh·∫≠t swing/BOS/ATR; detect FVG/OB/liquidity; c·∫≠p nh·∫≠t TTL.
* **SIGNAL_READY**: h·ªôi ƒë·ªß sweep + MSS + POI + filters.
* **PENDING**: ƒë·∫∑t limit; hu·ª∑ n·∫øu POI invalid/expired ho·∫∑c spread/news vi ph·∫°m.
* **ACTIVE**: qu·∫£n tr·ªã SL/TP/trail/partials.
* **EXITED**: ghi nh·∫≠t k√Ω; update POI state (Mitigated/Invalid).
* **CLEANUP**: v·∫Ω End Box, l∆∞u metrics.

## 3.11. Pseudocode (r√∫t g·ªçn ‚Äì ƒë·ªß cho dev)

```pseudo
on_bar_close():
  updateATR()
  swings = detectSwings(N=swing_lookback_period)                 // :contentReference[oaicite:55]{index=55}
  structure = updateStructure(swings, structure_break_type)       // BOS/MSS
  if isDisplacement(current_bar, ATR_period, ATR_mult):           // :contentReference[oaicite:56]{index=56}
      newFVGs = detectFVGs(current_index)                          // :contentReference[oaicite:57]{index=57}
      newOBs  = detectOBs(structure)                               // :contentReference[oaicite:58]{index=58}
      registerPOIs(newFVGs, newOBs)

  updateLiquidityMap(PDH/PDL, PWH/PWL, SessionHigh/Low, EQH/EQL)   // :contentReference[oaicite:59]{index=59}
  updatePOILifecycle(TTL, structure, ATR_regime)

  if sessionFilterOK() and spreadOK() and newsOK():
     for side in [LONG, SHORT]:
        sweepOK = detectLiquiditySweep(side)                       // :contentReference[oaicite:60]{index=60}
        mssOK   = structure.hasMSSWithDisplacement(side)
        poiList = getPOIs(side, inPremiumDiscountRange=true)       // :contentReference[oaicite:61]{index=61}
        if sweepOK and mssOK and not exceedLimits(side):
            sortedPOIs = prioritize(poiList)                       // sizeATR, age, confluence
            for poi in sortedPOIs:
               placeLimitAtEdge(poi)
               if exceedMaxPending(): break

on_tick():
  manageOrdersAndPositions():
    for pos in openPositions:
       if use_fixed_pips_sl_tp:
           enforceFixedSLTP(pos)
       else:
           enforceStructuralSL(pos)                                // SL = low/high of sweep :contentReference[oaicite:62]{index=62}
           setTPtoWeakHighLowOrRR(pos)                             // :contentReference[oaicite:63]{index=63}
           if momentum_mode: applyATRTrailing(pos)                 // :contentReference[oaicite:64]{index=64}
       if exitSignal(pos): close(pos)
  updateBoxesAndLabels()
```

## 3.12. Parameters (m·∫´u ch√≠nh)

| T√™n                           | Ki·ªÉu            |      Default |  Min/Max | [Why/Impact]                    |
| ----------------------------- | --------------- | -----------: | -------: | ------------------------------- |
| `swing_lookback_period`       | int             |            2 |      1‚Äì5 | Nh·∫≠n di·ªán fractal/swing.        |
| `structure_break_type`        | enum{Wick,Body} |         Body |        ‚Äì | Nghi√™m ng·∫∑t ph√° v·ª° b·∫±ng close.  |
| `displacement_atr_period`     | int             |           14 |     5‚Äì50 | ƒê·ªô nh·∫°y bi·∫øn ƒë·ªông.              |
| `displacement_atr_multiplier` | float           |          2.0 |      1‚Äì4 | N·∫øn ƒë·ªß ‚Äúm·∫°nh‚Äù.                  |
| `fvg_min_size_atr_mult`       | float           |          0.5 |    0.1‚Äì2 | L·ªçc FVG nh·ªè.                    |
| `poi_ttl_bars`                | int             |           48 |    5‚Äì500 | TTL theo th·ªùi gian.             |
| `atr_regime_min_ratio`        | float           |          0.6 |    0.3‚Äì1 | TTL theo regime.                |
| `max_pending_pois_per_side`   | int             |            3 |     1‚Äì10 | Tr√°nh overtrading.              |
| `max_positions_per_side`      | int             |            3 |     1‚Äì10 | Gi·ªõi h·∫°n ph∆°i nhi·ªÖm.            |
| `MaxLotPerSide`               | lot             | **b·∫°n ch·ªçn** |        ‚Äì | Tr·∫ßn t·ªïng kh·ªëi l∆∞·ª£ng m·ªói chi·ªÅu. |
| `use_fixed_pips_sl_tp`        | bool            |        false |        ‚Äì | B·∫≠t TP/SL theo pip (points).    |
| `sl_pips/tp_pips`             | float           | 500/1500 pts | 50‚Äì10000 | Override c·∫•u tr√∫c.              |
| `session_windows`             | json            |    London/NY |        ‚Äì | Kill Zones.                     |
| `premium_discount_filter`     | bool            |         true |        ‚Äì | L·ªçc v√πng ƒë√∫ng h∆∞·ªõng.            |
| `spread_max_points`           | int             |          400 |  50‚Äì2000 | Guard XAUUSD M5 (~350).         |

## 3.13. Backtest Protocol (t√≥m t·∫Øt)

* Data: 2‚Äì3 nƒÉm, M5 XAUUSD.
* WFO 70/30 theo qu√Ω, reject overfit khi PF ch√™nh > 30% gi·ªØa IS/OOS.
* T·ªëi ∆∞u: `ATR_mult`, `fvg_min_size_atr_mult`, `poi_ttl_bars`, `session_windows`.

## 3.14. Test Cases & Edge Cases

* Spread spike > `spread_max_points` ‚Üí **kh√¥ng** ƒë·∫∑t l·ªánh.
* Gap m·ªü c·ª≠a: POI b·ªã xuy√™n ‚Üí mark Invalidated & v·∫Ω End Box.
* Ch·∫°m POI trong **phi√™n c·∫•m** ‚Üí gi·ªØ PENDING nh∆∞ng **kh√¥ng kh·ªõp** (flag).
* FVG ch·∫°m 30% ‚Üí Partial; ch·∫°m 100% ‚Üí Mitigated; BOS ng∆∞·ª£c displacement ‚Üí Invalid.
* Nhi·ªÅu FVG: ch·ªâ gi·ªØ top-N theo priority; ‚Äúdrop oldest‚Äù khi v∆∞·ª£t `max_pending_pois_per_side`.

---

# 4) V√≠ d·ª• nh·ªè & sanity check

* **Displacement**: ATR(14)=200 pts; `ATR_mult=2.0` ‚áí n·∫øn ph·∫£i c√≥ range > 400 pts ƒë·ªÉ coi l√† displacement. 
* **FVG min size**: `fvg_min_size_atr_mult=0.5` ‚áí c·∫ßn ‚â•100 pts (n·∫øu ATR=200). 
* **TP theo c·∫•u tr√∫c**: sau Long, TP nh·∫Øm **ƒë·ªânh y·∫øu** g·∫ßn nh·∫•t (m·ª•c ti√™u thanh kho·∫£n) thay v√¨ s·ªë c·ªë ƒë·ªãnh ‚Üí nh·∫•t qu√°n v·ªõi SMC. 

---

## Devil‚Äôs Advocate (r·ªßi ro & ho√° gi·∫£i)

* **T√≠n hi·ªáu gi·∫£ trong range news/rollover** ‚Üí b·∫≠t session/news filter, y√™u c·∫ßu displacement + FVG ƒë·ªìng th·ªùi. 
* **‚ÄúQu√° nhi·ªÅu‚Äù POI** ‚Üí ∆∞u ti√™n & gi·ªõi h·∫°n N, `MaxLotPerSide` c·∫Øt ƒë·ªânh ph∆°i nhi·ªÖm.
* **Override fixed pips** c√≥ th·ªÉ tr√°i c·∫•u tr√∫c ‚Üí c·∫£nh b√°o khi RR<1.5 v√† g·ª£i √Ω TP c·∫•u tr√∫c l√†m TP2.

---

# K·∫øt

T√†i li·ªáu tr√™n ƒë√£ b·ªï sung ƒë√∫ng tr·ªçng t√¢m b·∫°n h·ªèi: ƒëi·ªÅu ki·ªán **h√¨nh th√†nh‚Äìk·∫øt th√∫c‚Äìrenew** cho **FVG/OB**, logic **v·∫Ω BOX & Text**, **quy t·∫Øc qu√©t n·∫øn/TTL**, **nhi·ªÅu FVG/nhi·ªÅu l·ªánh**, c√πng **TP/SL** theo ICT/SMC/Momentum (v√† ch·∫ø ƒë·ªô **TP/SL theo pip** c√≥ th·ªÉ config). C√°c ƒë·ªãnh nghƒ©a/c√¥ng th·ª©c ƒë·ªÅu ƒë√£ ‚Äúcodeable‚Äù v√† b√°m s√°t ngu·ªìn b·∫°n cung c·∫•p (FVG 3-candle, displacement=ATR-multiple, OB ph·∫£i d·∫´n ƒë·∫øn BOS k√®m FVG, Premium/Discount filter, Kill Zones, m·ª•c ti√™u ‚Äúƒëi·ªÉm y·∫øu‚Äù/BSL/SSL).      

---

## Self-Review & Confidence

* **Logic check**: ƒë√£ chuy·ªÉn ng√¥n ng·ªØ ICT/SMC ‚Üí ƒëi·ªÅu ki·ªán ƒëo-ƒë·∫øm (ATR, n·∫øn, points, TTL).
* **Edge cases**: spread spike, gaps, ƒëa POI, partial mitigation ƒë√£ c√≥.
* **Confidence: High**, v√¨ ƒë·∫∑c t·∫£ b√°m s√°t t√†i li·ªáu b·∫°n ƒë∆∞a (ƒë√£ tr√≠ch d·∫´n), ch·ªâ th√™m l·ªõp TTL/priority ƒë·ªÉ dev tri·ªÉn khai ·ªïn ƒë·ªãnh.

---

## C·∫ßn b·∫°n x√°c nh·∫≠n (ƒë·ªÉ m√¨nh ch·ªët b·∫£n cu·ªëi & handover cho dev):

1. `MaxLotPerSide` (con s·ªë m·∫∑c ƒë·ªãnh) v√† `max_pending_pois_per_side`.
2. D√πng **TP/SL theo pip** l√† **override** ho√†n to√†n hay ch·ªâ l√† **TP2/SL2** song song?
3. Gi·ªù **Kill Zones** theo broker time hay UTC?
4. Cho ph√©p **stack entries** tr√™n **1 POI** (EDGE/MID/50%) ch·ª©?
   X√°c nh·∫≠n xong, m√¨nh ƒë√≥ng g√≥i th√™m **b·∫£ng tham s·ªë ƒë·∫ßy ƒë·ªß**, **flow chi ti·∫øt**, v√† **test checklist**.
